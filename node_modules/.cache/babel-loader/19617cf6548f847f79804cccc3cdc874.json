{"ast":null,"code":"import \"core-js/modules/es.array.splice.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/es.array.sort.js\";\n\n/**\n * Provide WebGL layer to zrender. Which is rendered on top of clay.\n *\n *\n * Relationship between zrender, LayerGL(renderer) and ViewGL(Scene, Camera, Viewport)\n *           zrender\n *           /     \\\n *      LayerGL   LayerGL\n *    (renderer) (renderer)\n *      /     \\\n *  ViewGL   ViewGL\n */\nimport * as echarts from 'echarts/lib/echarts';\nimport Renderer from 'claygl/src/Renderer';\nimport RayPicking from 'claygl/src/picking/RayPicking';\nimport Texture from 'claygl/src/Texture';\nimport graphicGL from '../util/graphicGL'; // PENDING, clay. notifier is same with zrender Eventful\n\nimport notifier from 'claygl/src/core/mixin/notifier';\nimport requestAnimationFrame from 'zrender/lib/animation/requestAnimationFrame';\n/**\n * @constructor\n * @alias module:echarts-gl/core/LayerGL\n * @param {string} id Layer ID\n * @param {module:zrender/ZRender} zr\n */\n\nvar LayerGL = function LayerGL(id, zr) {\n  /**\n   * Layer ID\n   * @type {string}\n   */\n  this.id = id;\n  /**\n   * @type {module:zrender/ZRender}\n   */\n\n  this.zr = zr;\n  /**\n   * @type {clay.Renderer}\n   */\n\n  try {\n    this.renderer = new Renderer({\n      clearBit: 0,\n      devicePixelRatio: zr.painter.dpr,\n      preserveDrawingBuffer: true,\n      // PENDING\n      premultipliedAlpha: true\n    });\n    this.renderer.resize(zr.painter.getWidth(), zr.painter.getHeight());\n  } catch (e) {\n    this.renderer = null;\n    this.dom = document.createElement('div');\n    this.dom.style.cssText = 'position:absolute; left: 0; top: 0; right: 0; bottom: 0;';\n    this.dom.className = 'ecgl-nowebgl';\n    this.dom.innerHTML = 'Sorry, your browser does not support WebGL';\n    console.error(e);\n    return;\n  }\n\n  this.onglobalout = this.onglobalout.bind(this);\n  zr.on('globalout', this.onglobalout);\n  /**\n   * Canvas dom for webgl rendering\n   * @type {HTMLCanvasElement}\n   */\n\n  this.dom = this.renderer.canvas;\n  var style = this.dom.style;\n  style.position = 'absolute';\n  style.left = '0';\n  style.top = '0';\n  /**\n   * @type {Array.<clay.Scene>}\n   */\n\n  this.views = [];\n  this._picking = new RayPicking({\n    renderer: this.renderer\n  });\n  this._viewsToDispose = [];\n  /**\n   * Current accumulating id.\n   */\n\n  this._accumulatingId = 0;\n  this._zrEventProxy = new echarts.graphic.Rect({\n    shape: {\n      x: -1,\n      y: -1,\n      width: 2,\n      height: 2\n    },\n    // FIXME Better solution.\n    __isGLToZRProxy: true\n  });\n  this._backgroundColor = null;\n  this._disposed = false;\n};\n\nLayerGL.prototype.setUnpainted = function () {};\n/**\n * @param {module:echarts-gl/core/ViewGL} view\n */\n\n\nLayerGL.prototype.addView = function (view) {\n  if (view.layer === this) {\n    return;\n  } // If needs to dispose in this layer. unmark it.\n\n\n  var idx = this._viewsToDispose.indexOf(view);\n\n  if (idx >= 0) {\n    this._viewsToDispose.splice(idx, 1);\n  }\n\n  this.views.push(view);\n  view.layer = this;\n  var zr = this.zr;\n  view.scene.traverse(function (node) {\n    node.__zr = zr;\n\n    if (node.addAnimatorsToZr) {\n      node.addAnimatorsToZr(zr);\n    }\n  });\n};\n\nfunction removeFromZr(node) {\n  var zr = node.__zr;\n  node.__zr = null;\n\n  if (zr && node.removeAnimatorsFromZr) {\n    node.removeAnimatorsFromZr(zr);\n  }\n}\n/**\n * @param {module:echarts-gl/core/ViewGL} view\n */\n\n\nLayerGL.prototype.removeView = function (view) {\n  if (view.layer !== this) {\n    return;\n  }\n\n  var idx = this.views.indexOf(view);\n\n  if (idx >= 0) {\n    this.views.splice(idx, 1);\n    view.scene.traverse(removeFromZr, this);\n    view.layer = null; // Mark to dispose in this layer.\n\n    this._viewsToDispose.push(view);\n  }\n};\n/**\n * Remove all views\n */\n\n\nLayerGL.prototype.removeViewsAll = function () {\n  this.views.forEach(function (view) {\n    view.scene.traverse(removeFromZr, this);\n    view.layer = null; // Mark to dispose in this layer.\n\n    this._viewsToDispose.push(view);\n  }, this);\n  this.views.length = 0;\n};\n/**\n * Resize the canvas and viewport, will be invoked by zrender\n * @param  {number} width\n * @param  {number} height\n */\n\n\nLayerGL.prototype.resize = function (width, height) {\n  var renderer = this.renderer;\n  renderer.resize(width, height);\n};\n/**\n * Clear color and depth\n * @return {[type]} [description]\n */\n\n\nLayerGL.prototype.clear = function () {\n  var gl = this.renderer.gl;\n  var clearColor = this._backgroundColor || [0, 0, 0, 0];\n  gl.clearColor(clearColor[0], clearColor[1], clearColor[2], clearColor[3]);\n  gl.depthMask(true);\n  gl.colorMask(true, true, true, true);\n  gl.clear(gl.DEPTH_BUFFER_BIT | gl.COLOR_BUFFER_BIT);\n};\n/**\n * Clear depth\n */\n\n\nLayerGL.prototype.clearDepth = function () {\n  var gl = this.renderer.gl;\n  gl.clear(gl.DEPTH_BUFFER_BIT);\n};\n/**\n * Clear color\n */\n\n\nLayerGL.prototype.clearColor = function () {\n  var gl = this.renderer.gl;\n  gl.clearColor(0, 0, 0, 0);\n  gl.clear(gl.COLOR_BUFFER_BIT);\n};\n/**\n * Mark layer to refresh next tick\n */\n\n\nLayerGL.prototype.needsRefresh = function () {\n  this.zr.refresh();\n};\n/**\n * Refresh the layer, will be invoked by zrender\n */\n\n\nLayerGL.prototype.refresh = function (bgColor) {\n  this._backgroundColor = bgColor ? graphicGL.parseColor(bgColor) : [0, 0, 0, 0];\n  this.renderer.clearColor = this._backgroundColor;\n\n  for (var i = 0; i < this.views.length; i++) {\n    this.views[i].prepareRender(this.renderer);\n  }\n\n  this._doRender(false); // Auto dispose unused resources on GPU, like program(shader), texture, geometry(buffers)\n\n\n  this._trackAndClean(); // Dispose trashed views\n\n\n  for (var i = 0; i < this._viewsToDispose.length; i++) {\n    this._viewsToDispose[i].dispose(this.renderer);\n  }\n\n  this._viewsToDispose.length = 0;\n\n  this._startAccumulating();\n};\n\nLayerGL.prototype.renderToCanvas = function (ctx) {\n  // PENDING will block the page\n  this._startAccumulating(true);\n\n  ctx.drawImage(this.dom, 0, 0, ctx.canvas.width, ctx.canvas.height);\n};\n\nLayerGL.prototype._doRender = function (accumulating) {\n  this.clear();\n  this.renderer.saveViewport();\n\n  for (var i = 0; i < this.views.length; i++) {\n    this.views[i].render(this.renderer, accumulating);\n  }\n\n  this.renderer.restoreViewport();\n};\n/**\n * Stop accumulating\n */\n\n\nLayerGL.prototype._stopAccumulating = function () {\n  this._accumulatingId = 0;\n  clearTimeout(this._accumulatingTimeout);\n};\n\nvar accumulatingId = 1;\n/**\n * Start accumulating all the views.\n * Accumulating is for antialising and have more sampling in SSAO\n * @private\n */\n\nLayerGL.prototype._startAccumulating = function (immediate) {\n  var self = this;\n\n  this._stopAccumulating();\n\n  var needsAccumulate = false;\n\n  for (var i = 0; i < this.views.length; i++) {\n    needsAccumulate = this.views[i].needsAccumulate() || needsAccumulate;\n  }\n\n  if (!needsAccumulate) {\n    return;\n  }\n\n  function accumulate(id) {\n    if (!self._accumulatingId || id !== self._accumulatingId) {\n      return;\n    }\n\n    var isFinished = true;\n\n    for (var i = 0; i < self.views.length; i++) {\n      isFinished = self.views[i].isAccumulateFinished() && needsAccumulate;\n    }\n\n    if (!isFinished) {\n      self._doRender(true);\n\n      if (immediate) {\n        accumulate(id);\n      } else {\n        requestAnimationFrame(function () {\n          accumulate(id);\n        });\n      }\n    }\n  }\n\n  this._accumulatingId = accumulatingId++;\n\n  if (immediate) {\n    accumulate(self._accumulatingId);\n  } else {\n    this._accumulatingTimeout = setTimeout(function () {\n      accumulate(self._accumulatingId);\n    }, 50);\n  }\n};\n\nLayerGL.prototype._trackAndClean = function () {\n  var textureList = [];\n  var geometriesList = []; // Mark all resources unused;\n\n  if (this._textureList) {\n    markUnused(this._textureList);\n    markUnused(this._geometriesList);\n  }\n\n  for (var i = 0; i < this.views.length; i++) {\n    collectResources(this.views[i].scene, textureList, geometriesList);\n  } // Dispose those unsed resources.\n\n\n  if (this._textureList) {\n    checkAndDispose(this.renderer, this._textureList);\n    checkAndDispose(this.renderer, this._geometriesList);\n  }\n\n  this._textureList = textureList;\n  this._geometriesList = geometriesList;\n};\n\nfunction markUnused(resourceList) {\n  for (var i = 0; i < resourceList.length; i++) {\n    resourceList[i].__used__ = 0;\n  }\n}\n\nfunction checkAndDispose(renderer, resourceList) {\n  for (var i = 0; i < resourceList.length; i++) {\n    if (!resourceList[i].__used__) {\n      resourceList[i].dispose(renderer);\n    }\n  }\n}\n\nfunction updateUsed(resource, list) {\n  resource.__used__ = resource.__used__ || 0;\n  resource.__used__++;\n\n  if (resource.__used__ === 1) {\n    // Don't push to the list twice.\n    list.push(resource);\n  }\n}\n\nfunction collectResources(scene, textureResourceList, geometryResourceList) {\n  var prevMaterial;\n  var prevGeometry;\n  scene.traverse(function (renderable) {\n    if (renderable.isRenderable()) {\n      var geometry = renderable.geometry;\n      var material = renderable.material; // TODO optimize!!\n\n      if (material !== prevMaterial) {\n        var textureUniforms = material.getTextureUniforms();\n\n        for (var u = 0; u < textureUniforms.length; u++) {\n          var uniformName = textureUniforms[u];\n          var val = material.uniforms[uniformName].value;\n\n          if (!val) {\n            continue;\n          }\n\n          if (val instanceof Texture) {\n            updateUsed(val, textureResourceList);\n          } else if (val instanceof Array) {\n            for (var k = 0; k < val.length; k++) {\n              if (val[k] instanceof Texture) {\n                updateUsed(val[k], textureResourceList);\n              }\n            }\n          }\n        }\n      }\n\n      if (geometry !== prevGeometry) {\n        updateUsed(geometry, geometryResourceList);\n      }\n\n      prevMaterial = material;\n      prevGeometry = geometry;\n    }\n  });\n\n  for (var k = 0; k < scene.lights.length; k++) {\n    // Track AmbientCubemap\n    if (scene.lights[k].cubemap) {\n      updateUsed(scene.lights[k].cubemap, textureResourceList);\n    }\n  }\n}\n/**\n * Dispose the layer\n */\n\n\nLayerGL.prototype.dispose = function () {\n  if (this._disposed) {\n    return;\n  }\n\n  this._stopAccumulating();\n\n  if (this._textureList) {\n    markUnused(this._textureList);\n    markUnused(this._geometriesList);\n    checkAndDispose(this.renderer, this._textureList);\n    checkAndDispose(this.renderer, this._geometriesList);\n  }\n\n  this.zr.off('globalout', this.onglobalout);\n  this._disposed = true;\n}; // Event handlers\n\n\nLayerGL.prototype.onmousedown = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n\n  if (obj) {\n    this._dispatchEvent('mousedown', e, obj);\n\n    this._dispatchDataEvent('mousedown', e, obj);\n  }\n\n  this._downX = e.offsetX;\n  this._downY = e.offsetY;\n};\n\nLayerGL.prototype.onmousemove = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n  var target = obj && obj.target;\n  var lastHovered = this._hovered;\n  this._hovered = obj;\n\n  if (lastHovered && target !== lastHovered.target) {\n    lastHovered.relatedTarget = target;\n\n    this._dispatchEvent('mouseout', e, lastHovered); // this._dispatchDataEvent('mouseout', e, lastHovered);\n\n\n    this.zr.setCursorStyle('default');\n  }\n\n  this._dispatchEvent('mousemove', e, obj);\n\n  if (obj) {\n    this.zr.setCursorStyle('pointer');\n\n    if (!lastHovered || target !== lastHovered.target) {\n      this._dispatchEvent('mouseover', e, obj); // this._dispatchDataEvent('mouseover', e, obj);\n\n    }\n  }\n\n  this._dispatchDataEvent('mousemove', e, obj);\n};\n\nLayerGL.prototype.onmouseup = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n\n  if (obj) {\n    this._dispatchEvent('mouseup', e, obj);\n\n    this._dispatchDataEvent('mouseup', e, obj);\n  }\n\n  this._upX = e.offsetX;\n  this._upY = e.offsetY;\n};\n\nLayerGL.prototype.onclick = LayerGL.prototype.dblclick = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  } // Ignore click event if mouse moved\n\n\n  var dx = this._upX - this._downX;\n  var dy = this._upY - this._downY;\n\n  if (Math.sqrt(dx * dx + dy * dy) > 20) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n\n  if (obj) {\n    this._dispatchEvent(e.type, e, obj);\n\n    this._dispatchDataEvent(e.type, e, obj);\n  } // Try set depth of field onclick\n\n\n  var result = this._clickToSetFocusPoint(e);\n\n  if (result) {\n    var success = result.view.setDOFFocusOnPoint(result.distance);\n\n    if (success) {\n      this.zr.refresh();\n    }\n  }\n};\n\nLayerGL.prototype._clickToSetFocusPoint = function (e) {\n  var renderer = this.renderer;\n  var oldViewport = renderer.viewport;\n\n  for (var i = this.views.length - 1; i >= 0; i--) {\n    var viewGL = this.views[i];\n\n    if (viewGL.hasDOF() && viewGL.containPoint(e.offsetX, e.offsetY)) {\n      this._picking.scene = viewGL.scene;\n      this._picking.camera = viewGL.camera; // Only used for picking, renderer.setViewport will also invoke gl.viewport.\n      // Set directly, PENDING.\n\n      renderer.viewport = viewGL.viewport;\n\n      var result = this._picking.pick(e.offsetX, e.offsetY, true);\n\n      if (result) {\n        result.view = viewGL;\n        return result;\n      }\n    }\n  }\n\n  renderer.viewport = oldViewport;\n};\n\nLayerGL.prototype.onglobalout = function (e) {\n  var lastHovered = this._hovered;\n\n  if (lastHovered) {\n    this._dispatchEvent('mouseout', e, {\n      target: lastHovered.target\n    });\n  }\n};\n\nLayerGL.prototype.pickObject = function (x, y) {\n  var output = [];\n  var renderer = this.renderer;\n  var oldViewport = renderer.viewport;\n\n  for (var i = 0; i < this.views.length; i++) {\n    var viewGL = this.views[i];\n\n    if (viewGL.containPoint(x, y)) {\n      this._picking.scene = viewGL.scene;\n      this._picking.camera = viewGL.camera; // Only used for picking, renderer.setViewport will also invoke gl.viewport.\n      // Set directly, PENDING.\n\n      renderer.viewport = viewGL.viewport;\n\n      this._picking.pickAll(x, y, output);\n    }\n  }\n\n  renderer.viewport = oldViewport;\n  output.sort(function (a, b) {\n    return a.distance - b.distance;\n  });\n  return output[0];\n};\n\nLayerGL.prototype._dispatchEvent = function (eveName, originalEvent, newEvent) {\n  if (!newEvent) {\n    newEvent = {};\n  }\n\n  var current = newEvent.target;\n  newEvent.cancelBubble = false;\n  newEvent.event = originalEvent;\n  newEvent.type = eveName;\n  newEvent.offsetX = originalEvent.offsetX;\n  newEvent.offsetY = originalEvent.offsetY;\n\n  while (current) {\n    current.trigger(eveName, newEvent);\n    current = current.getParent();\n\n    if (newEvent.cancelBubble) {\n      break;\n    }\n  }\n\n  this._dispatchToView(eveName, newEvent);\n};\n\nLayerGL.prototype._dispatchDataEvent = function (eveName, originalEvent, newEvent) {\n  var mesh = newEvent && newEvent.target;\n  var dataIndex = mesh && mesh.dataIndex;\n  var seriesIndex = mesh && mesh.seriesIndex; // Custom event data\n\n  var eventData = mesh && mesh.eventData;\n  var elChangedInMouseMove = false;\n  var eventProxy = this._zrEventProxy;\n  eventProxy.x = originalEvent.offsetX;\n  eventProxy.y = originalEvent.offsetY;\n  eventProxy.update();\n  var targetInfo = {\n    target: eventProxy\n  };\n  var ecData = echarts.helper.getECData(eventProxy);\n\n  if (eveName === 'mousemove') {\n    if (dataIndex != null) {\n      if (dataIndex !== this._lastDataIndex) {\n        if (parseInt(this._lastDataIndex, 10) >= 0) {\n          ecData.dataIndex = this._lastDataIndex;\n          ecData.seriesIndex = this._lastSeriesIndex; // FIXME May cause double events.\n\n          this.zr.handler.dispatchToElement(targetInfo, 'mouseout', originalEvent);\n        }\n\n        elChangedInMouseMove = true;\n      }\n    } else if (eventData != null) {\n      if (eventData !== this._lastEventData) {\n        if (this._lastEventData != null) {\n          ecData.eventData = this._lastEventData; // FIXME May cause double events.\n\n          this.zr.handler.dispatchToElement(targetInfo, 'mouseout', originalEvent);\n        }\n\n        elChangedInMouseMove = true;\n      }\n    }\n\n    this._lastEventData = eventData;\n    this._lastDataIndex = dataIndex;\n    this._lastSeriesIndex = seriesIndex;\n  }\n\n  ecData.eventData = eventData;\n  ecData.dataIndex = dataIndex;\n  ecData.seriesIndex = seriesIndex;\n\n  if (eventData != null || parseInt(dataIndex, 10) >= 0 && parseInt(seriesIndex, 10) >= 0) {\n    this.zr.handler.dispatchToElement(targetInfo, eveName, originalEvent);\n\n    if (elChangedInMouseMove) {\n      this.zr.handler.dispatchToElement(targetInfo, 'mouseover', originalEvent);\n    }\n  }\n};\n\nLayerGL.prototype._dispatchToView = function (eventName, e) {\n  for (var i = 0; i < this.views.length; i++) {\n    if (this.views[i].containPoint(e.offsetX, e.offsetY)) {\n      this.views[i].trigger(eventName, e);\n    }\n  }\n};\n\nObject.assign(LayerGL.prototype, notifier);\nexport default LayerGL;","map":{"version":3,"sources":["C:/Users/Administrator/Desktop/data_view/my_project/vue2_app/myapp/node_modules/echarts-gl/lib/core/LayerGL.js"],"names":["echarts","Renderer","RayPicking","Texture","graphicGL","notifier","requestAnimationFrame","LayerGL","id","zr","renderer","clearBit","devicePixelRatio","painter","dpr","preserveDrawingBuffer","premultipliedAlpha","resize","getWidth","getHeight","e","dom","document","createElement","style","cssText","className","innerHTML","console","error","onglobalout","bind","on","canvas","position","left","top","views","_picking","_viewsToDispose","_accumulatingId","_zrEventProxy","graphic","Rect","shape","x","y","width","height","__isGLToZRProxy","_backgroundColor","_disposed","prototype","setUnpainted","addView","view","layer","idx","indexOf","splice","push","scene","traverse","node","__zr","addAnimatorsToZr","removeFromZr","removeAnimatorsFromZr","removeView","removeViewsAll","forEach","length","clear","gl","clearColor","depthMask","colorMask","DEPTH_BUFFER_BIT","COLOR_BUFFER_BIT","clearDepth","needsRefresh","refresh","bgColor","parseColor","i","prepareRender","_doRender","_trackAndClean","dispose","_startAccumulating","renderToCanvas","ctx","drawImage","accumulating","saveViewport","render","restoreViewport","_stopAccumulating","clearTimeout","_accumulatingTimeout","accumulatingId","immediate","self","needsAccumulate","accumulate","isFinished","isAccumulateFinished","setTimeout","textureList","geometriesList","_textureList","markUnused","_geometriesList","collectResources","checkAndDispose","resourceList","__used__","updateUsed","resource","list","textureResourceList","geometryResourceList","prevMaterial","prevGeometry","renderable","isRenderable","geometry","material","textureUniforms","getTextureUniforms","u","uniformName","val","uniforms","value","Array","k","lights","cubemap","off","onmousedown","target","event","obj","pickObject","offsetX","offsetY","_dispatchEvent","_dispatchDataEvent","_downX","_downY","onmousemove","lastHovered","_hovered","relatedTarget","setCursorStyle","onmouseup","_upX","_upY","onclick","dblclick","dx","dy","Math","sqrt","type","result","_clickToSetFocusPoint","success","setDOFFocusOnPoint","distance","oldViewport","viewport","viewGL","hasDOF","containPoint","camera","pick","output","pickAll","sort","a","b","eveName","originalEvent","newEvent","current","cancelBubble","trigger","getParent","_dispatchToView","mesh","dataIndex","seriesIndex","eventData","elChangedInMouseMove","eventProxy","update","targetInfo","ecData","helper","getECData","_lastDataIndex","parseInt","_lastSeriesIndex","handler","dispatchToElement","_lastEventData","eventName","Object","assign"],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,KAAKA,OAAZ,MAAyB,qBAAzB;AACA,OAAOC,QAAP,MAAqB,qBAArB;AACA,OAAOC,UAAP,MAAuB,+BAAvB;AACA,OAAOC,OAAP,MAAoB,oBAApB;AACA,OAAOC,SAAP,MAAsB,mBAAtB,C,CAA2C;;AAE3C,OAAOC,QAAP,MAAqB,gCAArB;AACA,OAAOC,qBAAP,MAAkC,6CAAlC;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,IAAIC,OAAO,GAAG,SAAVA,OAAU,CAAUC,EAAV,EAAcC,EAAd,EAAkB;AAC9B;AACF;AACA;AACA;AACE,OAAKD,EAAL,GAAUA,EAAV;AACA;AACF;AACA;;AAEE,OAAKC,EAAL,GAAUA,EAAV;AACA;AACF;AACA;;AAEE,MAAI;AACF,SAAKC,QAAL,GAAgB,IAAIT,QAAJ,CAAa;AAC3BU,MAAAA,QAAQ,EAAE,CADiB;AAE3BC,MAAAA,gBAAgB,EAAEH,EAAE,CAACI,OAAH,CAAWC,GAFF;AAG3BC,MAAAA,qBAAqB,EAAE,IAHI;AAI3B;AACAC,MAAAA,kBAAkB,EAAE;AALO,KAAb,CAAhB;AAOA,SAAKN,QAAL,CAAcO,MAAd,CAAqBR,EAAE,CAACI,OAAH,CAAWK,QAAX,EAArB,EAA4CT,EAAE,CAACI,OAAH,CAAWM,SAAX,EAA5C;AACD,GATD,CASE,OAAOC,CAAP,EAAU;AACV,SAAKV,QAAL,GAAgB,IAAhB;AACA,SAAKW,GAAL,GAAWC,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAAX;AACA,SAAKF,GAAL,CAASG,KAAT,CAAeC,OAAf,GAAyB,0DAAzB;AACA,SAAKJ,GAAL,CAASK,SAAT,GAAqB,cAArB;AACA,SAAKL,GAAL,CAASM,SAAT,GAAqB,4CAArB;AACAC,IAAAA,OAAO,CAACC,KAAR,CAAcT,CAAd;AACA;AACD;;AAED,OAAKU,WAAL,GAAmB,KAAKA,WAAL,CAAiBC,IAAjB,CAAsB,IAAtB,CAAnB;AACAtB,EAAAA,EAAE,CAACuB,EAAH,CAAM,WAAN,EAAmB,KAAKF,WAAxB;AACA;AACF;AACA;AACA;;AAEE,OAAKT,GAAL,GAAW,KAAKX,QAAL,CAAcuB,MAAzB;AACA,MAAIT,KAAK,GAAG,KAAKH,GAAL,CAASG,KAArB;AACAA,EAAAA,KAAK,CAACU,QAAN,GAAiB,UAAjB;AACAV,EAAAA,KAAK,CAACW,IAAN,GAAa,GAAb;AACAX,EAAAA,KAAK,CAACY,GAAN,GAAY,GAAZ;AACA;AACF;AACA;;AAEE,OAAKC,KAAL,GAAa,EAAb;AACA,OAAKC,QAAL,GAAgB,IAAIpC,UAAJ,CAAe;AAC7BQ,IAAAA,QAAQ,EAAE,KAAKA;AADc,GAAf,CAAhB;AAGA,OAAK6B,eAAL,GAAuB,EAAvB;AACA;AACF;AACA;;AAEE,OAAKC,eAAL,GAAuB,CAAvB;AACA,OAAKC,aAAL,GAAqB,IAAIzC,OAAO,CAAC0C,OAAR,CAAgBC,IAApB,CAAyB;AAC5CC,IAAAA,KAAK,EAAE;AACLC,MAAAA,CAAC,EAAE,CAAC,CADC;AAELC,MAAAA,CAAC,EAAE,CAAC,CAFC;AAGLC,MAAAA,KAAK,EAAE,CAHF;AAILC,MAAAA,MAAM,EAAE;AAJH,KADqC;AAO5C;AACAC,IAAAA,eAAe,EAAE;AAR2B,GAAzB,CAArB;AAUA,OAAKC,gBAAL,GAAwB,IAAxB;AACA,OAAKC,SAAL,GAAiB,KAAjB;AACD,CAxED;;AA0EA5C,OAAO,CAAC6C,SAAR,CAAkBC,YAAlB,GAAiC,YAAY,CAAE,CAA/C;AACA;AACA;AACA;;;AAGA9C,OAAO,CAAC6C,SAAR,CAAkBE,OAAlB,GAA4B,UAAUC,IAAV,EAAgB;AAC1C,MAAIA,IAAI,CAACC,KAAL,KAAe,IAAnB,EAAyB;AACvB;AACD,GAHyC,CAGxC;;;AAGF,MAAIC,GAAG,GAAG,KAAKlB,eAAL,CAAqBmB,OAArB,CAA6BH,IAA7B,CAAV;;AAEA,MAAIE,GAAG,IAAI,CAAX,EAAc;AACZ,SAAKlB,eAAL,CAAqBoB,MAArB,CAA4BF,GAA5B,EAAiC,CAAjC;AACD;;AAED,OAAKpB,KAAL,CAAWuB,IAAX,CAAgBL,IAAhB;AACAA,EAAAA,IAAI,CAACC,KAAL,GAAa,IAAb;AACA,MAAI/C,EAAE,GAAG,KAAKA,EAAd;AACA8C,EAAAA,IAAI,CAACM,KAAL,CAAWC,QAAX,CAAoB,UAAUC,IAAV,EAAgB;AAClCA,IAAAA,IAAI,CAACC,IAAL,GAAYvD,EAAZ;;AAEA,QAAIsD,IAAI,CAACE,gBAAT,EAA2B;AACzBF,MAAAA,IAAI,CAACE,gBAAL,CAAsBxD,EAAtB;AACD;AACF,GAND;AAOD,CAtBD;;AAwBA,SAASyD,YAAT,CAAsBH,IAAtB,EAA4B;AAC1B,MAAItD,EAAE,GAAGsD,IAAI,CAACC,IAAd;AACAD,EAAAA,IAAI,CAACC,IAAL,GAAY,IAAZ;;AAEA,MAAIvD,EAAE,IAAIsD,IAAI,CAACI,qBAAf,EAAsC;AACpCJ,IAAAA,IAAI,CAACI,qBAAL,CAA2B1D,EAA3B;AACD;AACF;AACD;AACA;AACA;;;AAGAF,OAAO,CAAC6C,SAAR,CAAkBgB,UAAlB,GAA+B,UAAUb,IAAV,EAAgB;AAC7C,MAAIA,IAAI,CAACC,KAAL,KAAe,IAAnB,EAAyB;AACvB;AACD;;AAED,MAAIC,GAAG,GAAG,KAAKpB,KAAL,CAAWqB,OAAX,CAAmBH,IAAnB,CAAV;;AAEA,MAAIE,GAAG,IAAI,CAAX,EAAc;AACZ,SAAKpB,KAAL,CAAWsB,MAAX,CAAkBF,GAAlB,EAAuB,CAAvB;AACAF,IAAAA,IAAI,CAACM,KAAL,CAAWC,QAAX,CAAoBI,YAApB,EAAkC,IAAlC;AACAX,IAAAA,IAAI,CAACC,KAAL,GAAa,IAAb,CAHY,CAGO;;AAEnB,SAAKjB,eAAL,CAAqBqB,IAArB,CAA0BL,IAA1B;AACD;AACF,CAdD;AAeA;AACA;AACA;;;AAGAhD,OAAO,CAAC6C,SAAR,CAAkBiB,cAAlB,GAAmC,YAAY;AAC7C,OAAKhC,KAAL,CAAWiC,OAAX,CAAmB,UAAUf,IAAV,EAAgB;AACjCA,IAAAA,IAAI,CAACM,KAAL,CAAWC,QAAX,CAAoBI,YAApB,EAAkC,IAAlC;AACAX,IAAAA,IAAI,CAACC,KAAL,GAAa,IAAb,CAFiC,CAEd;;AAEnB,SAAKjB,eAAL,CAAqBqB,IAArB,CAA0BL,IAA1B;AACD,GALD,EAKG,IALH;AAMA,OAAKlB,KAAL,CAAWkC,MAAX,GAAoB,CAApB;AACD,CARD;AASA;AACA;AACA;AACA;AACA;;;AAGAhE,OAAO,CAAC6C,SAAR,CAAkBnC,MAAlB,GAA2B,UAAU8B,KAAV,EAAiBC,MAAjB,EAAyB;AAClD,MAAItC,QAAQ,GAAG,KAAKA,QAApB;AACAA,EAAAA,QAAQ,CAACO,MAAT,CAAgB8B,KAAhB,EAAuBC,MAAvB;AACD,CAHD;AAIA;AACA;AACA;AACA;;;AAGAzC,OAAO,CAAC6C,SAAR,CAAkBoB,KAAlB,GAA0B,YAAY;AACpC,MAAIC,EAAE,GAAG,KAAK/D,QAAL,CAAc+D,EAAvB;AACA,MAAIC,UAAU,GAAG,KAAKxB,gBAAL,IAAyB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CAA1C;AACAuB,EAAAA,EAAE,CAACC,UAAH,CAAcA,UAAU,CAAC,CAAD,CAAxB,EAA6BA,UAAU,CAAC,CAAD,CAAvC,EAA4CA,UAAU,CAAC,CAAD,CAAtD,EAA2DA,UAAU,CAAC,CAAD,CAArE;AACAD,EAAAA,EAAE,CAACE,SAAH,CAAa,IAAb;AACAF,EAAAA,EAAE,CAACG,SAAH,CAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B;AACAH,EAAAA,EAAE,CAACD,KAAH,CAASC,EAAE,CAACI,gBAAH,GAAsBJ,EAAE,CAACK,gBAAlC;AACD,CAPD;AAQA;AACA;AACA;;;AAGAvE,OAAO,CAAC6C,SAAR,CAAkB2B,UAAlB,GAA+B,YAAY;AACzC,MAAIN,EAAE,GAAG,KAAK/D,QAAL,CAAc+D,EAAvB;AACAA,EAAAA,EAAE,CAACD,KAAH,CAASC,EAAE,CAACI,gBAAZ;AACD,CAHD;AAIA;AACA;AACA;;;AAGAtE,OAAO,CAAC6C,SAAR,CAAkBsB,UAAlB,GAA+B,YAAY;AACzC,MAAID,EAAE,GAAG,KAAK/D,QAAL,CAAc+D,EAAvB;AACAA,EAAAA,EAAE,CAACC,UAAH,CAAc,CAAd,EAAiB,CAAjB,EAAoB,CAApB,EAAuB,CAAvB;AACAD,EAAAA,EAAE,CAACD,KAAH,CAASC,EAAE,CAACK,gBAAZ;AACD,CAJD;AAKA;AACA;AACA;;;AAGAvE,OAAO,CAAC6C,SAAR,CAAkB4B,YAAlB,GAAiC,YAAY;AAC3C,OAAKvE,EAAL,CAAQwE,OAAR;AACD,CAFD;AAGA;AACA;AACA;;;AAGA1E,OAAO,CAAC6C,SAAR,CAAkB6B,OAAlB,GAA4B,UAAUC,OAAV,EAAmB;AAC7C,OAAKhC,gBAAL,GAAwBgC,OAAO,GAAG9E,SAAS,CAAC+E,UAAV,CAAqBD,OAArB,CAAH,GAAmC,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CAAlE;AACA,OAAKxE,QAAL,CAAcgE,UAAd,GAA2B,KAAKxB,gBAAhC;;AAEA,OAAK,IAAIkC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1C,SAAK/C,KAAL,CAAW+C,CAAX,EAAcC,aAAd,CAA4B,KAAK3E,QAAjC;AACD;;AAED,OAAK4E,SAAL,CAAe,KAAf,EAR6C,CAQtB;;;AAGvB,OAAKC,cAAL,GAX6C,CAWtB;;;AAGvB,OAAK,IAAIH,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK7C,eAAL,CAAqBgC,MAAzC,EAAiDa,CAAC,EAAlD,EAAsD;AACpD,SAAK7C,eAAL,CAAqB6C,CAArB,EAAwBI,OAAxB,CAAgC,KAAK9E,QAArC;AACD;;AAED,OAAK6B,eAAL,CAAqBgC,MAArB,GAA8B,CAA9B;;AAEA,OAAKkB,kBAAL;AACD,CArBD;;AAuBAlF,OAAO,CAAC6C,SAAR,CAAkBsC,cAAlB,GAAmC,UAAUC,GAAV,EAAe;AAChD;AACA,OAAKF,kBAAL,CAAwB,IAAxB;;AAEAE,EAAAA,GAAG,CAACC,SAAJ,CAAc,KAAKvE,GAAnB,EAAwB,CAAxB,EAA2B,CAA3B,EAA8BsE,GAAG,CAAC1D,MAAJ,CAAWc,KAAzC,EAAgD4C,GAAG,CAAC1D,MAAJ,CAAWe,MAA3D;AACD,CALD;;AAOAzC,OAAO,CAAC6C,SAAR,CAAkBkC,SAAlB,GAA8B,UAAUO,YAAV,EAAwB;AACpD,OAAKrB,KAAL;AACA,OAAK9D,QAAL,CAAcoF,YAAd;;AAEA,OAAK,IAAIV,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1C,SAAK/C,KAAL,CAAW+C,CAAX,EAAcW,MAAd,CAAqB,KAAKrF,QAA1B,EAAoCmF,YAApC;AACD;;AAED,OAAKnF,QAAL,CAAcsF,eAAd;AACD,CATD;AAUA;AACA;AACA;;;AAGAzF,OAAO,CAAC6C,SAAR,CAAkB6C,iBAAlB,GAAsC,YAAY;AAChD,OAAKzD,eAAL,GAAuB,CAAvB;AACA0D,EAAAA,YAAY,CAAC,KAAKC,oBAAN,CAAZ;AACD,CAHD;;AAKA,IAAIC,cAAc,GAAG,CAArB;AACA;AACA;AACA;AACA;AACA;;AAEA7F,OAAO,CAAC6C,SAAR,CAAkBqC,kBAAlB,GAAuC,UAAUY,SAAV,EAAqB;AAC1D,MAAIC,IAAI,GAAG,IAAX;;AAEA,OAAKL,iBAAL;;AAEA,MAAIM,eAAe,GAAG,KAAtB;;AAEA,OAAK,IAAInB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1CmB,IAAAA,eAAe,GAAG,KAAKlE,KAAL,CAAW+C,CAAX,EAAcmB,eAAd,MAAmCA,eAArD;AACD;;AAED,MAAI,CAACA,eAAL,EAAsB;AACpB;AACD;;AAED,WAASC,UAAT,CAAoBhG,EAApB,EAAwB;AACtB,QAAI,CAAC8F,IAAI,CAAC9D,eAAN,IAAyBhC,EAAE,KAAK8F,IAAI,CAAC9D,eAAzC,EAA0D;AACxD;AACD;;AAED,QAAIiE,UAAU,GAAG,IAAjB;;AAEA,SAAK,IAAIrB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGkB,IAAI,CAACjE,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1CqB,MAAAA,UAAU,GAAGH,IAAI,CAACjE,KAAL,CAAW+C,CAAX,EAAcsB,oBAAd,MAAwCH,eAArD;AACD;;AAED,QAAI,CAACE,UAAL,EAAiB;AACfH,MAAAA,IAAI,CAAChB,SAAL,CAAe,IAAf;;AAEA,UAAIe,SAAJ,EAAe;AACbG,QAAAA,UAAU,CAAChG,EAAD,CAAV;AACD,OAFD,MAEO;AACLF,QAAAA,qBAAqB,CAAC,YAAY;AAChCkG,UAAAA,UAAU,CAAChG,EAAD,CAAV;AACD,SAFoB,CAArB;AAGD;AACF;AACF;;AAED,OAAKgC,eAAL,GAAuB4D,cAAc,EAArC;;AAEA,MAAIC,SAAJ,EAAe;AACbG,IAAAA,UAAU,CAACF,IAAI,CAAC9D,eAAN,CAAV;AACD,GAFD,MAEO;AACL,SAAK2D,oBAAL,GAA4BQ,UAAU,CAAC,YAAY;AACjDH,MAAAA,UAAU,CAACF,IAAI,CAAC9D,eAAN,CAAV;AACD,KAFqC,EAEnC,EAFmC,CAAtC;AAGD;AACF,CAhDD;;AAkDAjC,OAAO,CAAC6C,SAAR,CAAkBmC,cAAlB,GAAmC,YAAY;AAC7C,MAAIqB,WAAW,GAAG,EAAlB;AACA,MAAIC,cAAc,GAAG,EAArB,CAF6C,CAEpB;;AAEzB,MAAI,KAAKC,YAAT,EAAuB;AACrBC,IAAAA,UAAU,CAAC,KAAKD,YAAN,CAAV;AACAC,IAAAA,UAAU,CAAC,KAAKC,eAAN,CAAV;AACD;;AAED,OAAK,IAAI5B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1C6B,IAAAA,gBAAgB,CAAC,KAAK5E,KAAL,CAAW+C,CAAX,EAAcvB,KAAf,EAAsB+C,WAAtB,EAAmCC,cAAnC,CAAhB;AACD,GAX4C,CAW3C;;;AAGF,MAAI,KAAKC,YAAT,EAAuB;AACrBI,IAAAA,eAAe,CAAC,KAAKxG,QAAN,EAAgB,KAAKoG,YAArB,CAAf;AACAI,IAAAA,eAAe,CAAC,KAAKxG,QAAN,EAAgB,KAAKsG,eAArB,CAAf;AACD;;AAED,OAAKF,YAAL,GAAoBF,WAApB;AACA,OAAKI,eAAL,GAAuBH,cAAvB;AACD,CArBD;;AAuBA,SAASE,UAAT,CAAoBI,YAApB,EAAkC;AAChC,OAAK,IAAI/B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+B,YAAY,CAAC5C,MAAjC,EAAyCa,CAAC,EAA1C,EAA8C;AAC5C+B,IAAAA,YAAY,CAAC/B,CAAD,CAAZ,CAAgBgC,QAAhB,GAA2B,CAA3B;AACD;AACF;;AAED,SAASF,eAAT,CAAyBxG,QAAzB,EAAmCyG,YAAnC,EAAiD;AAC/C,OAAK,IAAI/B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+B,YAAY,CAAC5C,MAAjC,EAAyCa,CAAC,EAA1C,EAA8C;AAC5C,QAAI,CAAC+B,YAAY,CAAC/B,CAAD,CAAZ,CAAgBgC,QAArB,EAA+B;AAC7BD,MAAAA,YAAY,CAAC/B,CAAD,CAAZ,CAAgBI,OAAhB,CAAwB9E,QAAxB;AACD;AACF;AACF;;AAED,SAAS2G,UAAT,CAAoBC,QAApB,EAA8BC,IAA9B,EAAoC;AAClCD,EAAAA,QAAQ,CAACF,QAAT,GAAoBE,QAAQ,CAACF,QAAT,IAAqB,CAAzC;AACAE,EAAAA,QAAQ,CAACF,QAAT;;AAEA,MAAIE,QAAQ,CAACF,QAAT,KAAsB,CAA1B,EAA6B;AAC3B;AACAG,IAAAA,IAAI,CAAC3D,IAAL,CAAU0D,QAAV;AACD;AACF;;AAED,SAASL,gBAAT,CAA0BpD,KAA1B,EAAiC2D,mBAAjC,EAAsDC,oBAAtD,EAA4E;AAC1E,MAAIC,YAAJ;AACA,MAAIC,YAAJ;AACA9D,EAAAA,KAAK,CAACC,QAAN,CAAe,UAAU8D,UAAV,EAAsB;AACnC,QAAIA,UAAU,CAACC,YAAX,EAAJ,EAA+B;AAC7B,UAAIC,QAAQ,GAAGF,UAAU,CAACE,QAA1B;AACA,UAAIC,QAAQ,GAAGH,UAAU,CAACG,QAA1B,CAF6B,CAEO;;AAEpC,UAAIA,QAAQ,KAAKL,YAAjB,EAA+B;AAC7B,YAAIM,eAAe,GAAGD,QAAQ,CAACE,kBAAT,EAAtB;;AAEA,aAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,eAAe,CAACzD,MAApC,EAA4C2D,CAAC,EAA7C,EAAiD;AAC/C,cAAIC,WAAW,GAAGH,eAAe,CAACE,CAAD,CAAjC;AACA,cAAIE,GAAG,GAAGL,QAAQ,CAACM,QAAT,CAAkBF,WAAlB,EAA+BG,KAAzC;;AAEA,cAAI,CAACF,GAAL,EAAU;AACR;AACD;;AAED,cAAIA,GAAG,YAAYjI,OAAnB,EAA4B;AAC1BkH,YAAAA,UAAU,CAACe,GAAD,EAAMZ,mBAAN,CAAV;AACD,WAFD,MAEO,IAAIY,GAAG,YAAYG,KAAnB,EAA0B;AAC/B,iBAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,GAAG,CAAC7D,MAAxB,EAAgCiE,CAAC,EAAjC,EAAqC;AACnC,kBAAIJ,GAAG,CAACI,CAAD,CAAH,YAAkBrI,OAAtB,EAA+B;AAC7BkH,gBAAAA,UAAU,CAACe,GAAG,CAACI,CAAD,CAAJ,EAAShB,mBAAT,CAAV;AACD;AACF;AACF;AACF;AACF;;AAED,UAAIM,QAAQ,KAAKH,YAAjB,EAA+B;AAC7BN,QAAAA,UAAU,CAACS,QAAD,EAAWL,oBAAX,CAAV;AACD;;AAEDC,MAAAA,YAAY,GAAGK,QAAf;AACAJ,MAAAA,YAAY,GAAGG,QAAf;AACD;AACF,GAnCD;;AAqCA,OAAK,IAAIU,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG3E,KAAK,CAAC4E,MAAN,CAAalE,MAAjC,EAAyCiE,CAAC,EAA1C,EAA8C;AAC5C;AACA,QAAI3E,KAAK,CAAC4E,MAAN,CAAaD,CAAb,EAAgBE,OAApB,EAA6B;AAC3BrB,MAAAA,UAAU,CAACxD,KAAK,CAAC4E,MAAN,CAAaD,CAAb,EAAgBE,OAAjB,EAA0BlB,mBAA1B,CAAV;AACD;AACF;AACF;AACD;AACA;AACA;;;AAGAjH,OAAO,CAAC6C,SAAR,CAAkBoC,OAAlB,GAA4B,YAAY;AACtC,MAAI,KAAKrC,SAAT,EAAoB;AAClB;AACD;;AAED,OAAK8C,iBAAL;;AAEA,MAAI,KAAKa,YAAT,EAAuB;AACrBC,IAAAA,UAAU,CAAC,KAAKD,YAAN,CAAV;AACAC,IAAAA,UAAU,CAAC,KAAKC,eAAN,CAAV;AACAE,IAAAA,eAAe,CAAC,KAAKxG,QAAN,EAAgB,KAAKoG,YAArB,CAAf;AACAI,IAAAA,eAAe,CAAC,KAAKxG,QAAN,EAAgB,KAAKsG,eAArB,CAAf;AACD;;AAED,OAAKvG,EAAL,CAAQkI,GAAR,CAAY,WAAZ,EAAyB,KAAK7G,WAA9B;AACA,OAAKqB,SAAL,GAAiB,IAAjB;AACD,CAhBD,C,CAgBG;;;AAGH5C,OAAO,CAAC6C,SAAR,CAAkBwF,WAAlB,GAAgC,UAAUxH,CAAV,EAAa;AAC3C,MAAIA,CAAC,CAACyH,MAAF,IAAYzH,CAAC,CAACyH,MAAF,CAAS5F,eAAzB,EAA0C;AACxC;AACD;;AAED7B,EAAAA,CAAC,GAAGA,CAAC,CAAC0H,KAAN;AACA,MAAIC,GAAG,GAAG,KAAKC,UAAL,CAAgB5H,CAAC,CAAC6H,OAAlB,EAA2B7H,CAAC,CAAC8H,OAA7B,CAAV;;AAEA,MAAIH,GAAJ,EAAS;AACP,SAAKI,cAAL,CAAoB,WAApB,EAAiC/H,CAAjC,EAAoC2H,GAApC;;AAEA,SAAKK,kBAAL,CAAwB,WAAxB,EAAqChI,CAArC,EAAwC2H,GAAxC;AACD;;AAED,OAAKM,MAAL,GAAcjI,CAAC,CAAC6H,OAAhB;AACA,OAAKK,MAAL,GAAclI,CAAC,CAAC8H,OAAhB;AACD,CAhBD;;AAkBA3I,OAAO,CAAC6C,SAAR,CAAkBmG,WAAlB,GAAgC,UAAUnI,CAAV,EAAa;AAC3C,MAAIA,CAAC,CAACyH,MAAF,IAAYzH,CAAC,CAACyH,MAAF,CAAS5F,eAAzB,EAA0C;AACxC;AACD;;AAED7B,EAAAA,CAAC,GAAGA,CAAC,CAAC0H,KAAN;AACA,MAAIC,GAAG,GAAG,KAAKC,UAAL,CAAgB5H,CAAC,CAAC6H,OAAlB,EAA2B7H,CAAC,CAAC8H,OAA7B,CAAV;AACA,MAAIL,MAAM,GAAGE,GAAG,IAAIA,GAAG,CAACF,MAAxB;AACA,MAAIW,WAAW,GAAG,KAAKC,QAAvB;AACA,OAAKA,QAAL,GAAgBV,GAAhB;;AAEA,MAAIS,WAAW,IAAIX,MAAM,KAAKW,WAAW,CAACX,MAA1C,EAAkD;AAChDW,IAAAA,WAAW,CAACE,aAAZ,GAA4Bb,MAA5B;;AAEA,SAAKM,cAAL,CAAoB,UAApB,EAAgC/H,CAAhC,EAAmCoI,WAAnC,EAHgD,CAGC;;;AAGjD,SAAK/I,EAAL,CAAQkJ,cAAR,CAAuB,SAAvB;AACD;;AAED,OAAKR,cAAL,CAAoB,WAApB,EAAiC/H,CAAjC,EAAoC2H,GAApC;;AAEA,MAAIA,GAAJ,EAAS;AACP,SAAKtI,EAAL,CAAQkJ,cAAR,CAAuB,SAAvB;;AAEA,QAAI,CAACH,WAAD,IAAgBX,MAAM,KAAKW,WAAW,CAACX,MAA3C,EAAmD;AACjD,WAAKM,cAAL,CAAoB,WAApB,EAAiC/H,CAAjC,EAAoC2H,GAApC,EADiD,CACP;;AAE3C;AACF;;AAED,OAAKK,kBAAL,CAAwB,WAAxB,EAAqChI,CAArC,EAAwC2H,GAAxC;AACD,CAhCD;;AAkCAxI,OAAO,CAAC6C,SAAR,CAAkBwG,SAAlB,GAA8B,UAAUxI,CAAV,EAAa;AACzC,MAAIA,CAAC,CAACyH,MAAF,IAAYzH,CAAC,CAACyH,MAAF,CAAS5F,eAAzB,EAA0C;AACxC;AACD;;AAED7B,EAAAA,CAAC,GAAGA,CAAC,CAAC0H,KAAN;AACA,MAAIC,GAAG,GAAG,KAAKC,UAAL,CAAgB5H,CAAC,CAAC6H,OAAlB,EAA2B7H,CAAC,CAAC8H,OAA7B,CAAV;;AAEA,MAAIH,GAAJ,EAAS;AACP,SAAKI,cAAL,CAAoB,SAApB,EAA+B/H,CAA/B,EAAkC2H,GAAlC;;AAEA,SAAKK,kBAAL,CAAwB,SAAxB,EAAmChI,CAAnC,EAAsC2H,GAAtC;AACD;;AAED,OAAKc,IAAL,GAAYzI,CAAC,CAAC6H,OAAd;AACA,OAAKa,IAAL,GAAY1I,CAAC,CAAC8H,OAAd;AACD,CAhBD;;AAkBA3I,OAAO,CAAC6C,SAAR,CAAkB2G,OAAlB,GAA4BxJ,OAAO,CAAC6C,SAAR,CAAkB4G,QAAlB,GAA6B,UAAU5I,CAAV,EAAa;AACpE,MAAIA,CAAC,CAACyH,MAAF,IAAYzH,CAAC,CAACyH,MAAF,CAAS5F,eAAzB,EAA0C;AACxC;AACD,GAHmE,CAGlE;;;AAGF,MAAIgH,EAAE,GAAG,KAAKJ,IAAL,GAAY,KAAKR,MAA1B;AACA,MAAIa,EAAE,GAAG,KAAKJ,IAAL,GAAY,KAAKR,MAA1B;;AAEA,MAAIa,IAAI,CAACC,IAAL,CAAUH,EAAE,GAAGA,EAAL,GAAUC,EAAE,GAAGA,EAAzB,IAA+B,EAAnC,EAAuC;AACrC;AACD;;AAED9I,EAAAA,CAAC,GAAGA,CAAC,CAAC0H,KAAN;AACA,MAAIC,GAAG,GAAG,KAAKC,UAAL,CAAgB5H,CAAC,CAAC6H,OAAlB,EAA2B7H,CAAC,CAAC8H,OAA7B,CAAV;;AAEA,MAAIH,GAAJ,EAAS;AACP,SAAKI,cAAL,CAAoB/H,CAAC,CAACiJ,IAAtB,EAA4BjJ,CAA5B,EAA+B2H,GAA/B;;AAEA,SAAKK,kBAAL,CAAwBhI,CAAC,CAACiJ,IAA1B,EAAgCjJ,CAAhC,EAAmC2H,GAAnC;AACD,GApBmE,CAoBlE;;;AAGF,MAAIuB,MAAM,GAAG,KAAKC,qBAAL,CAA2BnJ,CAA3B,CAAb;;AAEA,MAAIkJ,MAAJ,EAAY;AACV,QAAIE,OAAO,GAAGF,MAAM,CAAC/G,IAAP,CAAYkH,kBAAZ,CAA+BH,MAAM,CAACI,QAAtC,CAAd;;AAEA,QAAIF,OAAJ,EAAa;AACX,WAAK/J,EAAL,CAAQwE,OAAR;AACD;AACF;AACF,CAhCD;;AAkCA1E,OAAO,CAAC6C,SAAR,CAAkBmH,qBAAlB,GAA0C,UAAUnJ,CAAV,EAAa;AACrD,MAAIV,QAAQ,GAAG,KAAKA,QAApB;AACA,MAAIiK,WAAW,GAAGjK,QAAQ,CAACkK,QAA3B;;AAEA,OAAK,IAAIxF,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAAX,GAAoB,CAAjC,EAAoCa,CAAC,IAAI,CAAzC,EAA4CA,CAAC,EAA7C,EAAiD;AAC/C,QAAIyF,MAAM,GAAG,KAAKxI,KAAL,CAAW+C,CAAX,CAAb;;AAEA,QAAIyF,MAAM,CAACC,MAAP,MAAmBD,MAAM,CAACE,YAAP,CAAoB3J,CAAC,CAAC6H,OAAtB,EAA+B7H,CAAC,CAAC8H,OAAjC,CAAvB,EAAkE;AAChE,WAAK5G,QAAL,CAAcuB,KAAd,GAAsBgH,MAAM,CAAChH,KAA7B;AACA,WAAKvB,QAAL,CAAc0I,MAAd,GAAuBH,MAAM,CAACG,MAA9B,CAFgE,CAE1B;AACtC;;AAEAtK,MAAAA,QAAQ,CAACkK,QAAT,GAAoBC,MAAM,CAACD,QAA3B;;AAEA,UAAIN,MAAM,GAAG,KAAKhI,QAAL,CAAc2I,IAAd,CAAmB7J,CAAC,CAAC6H,OAArB,EAA8B7H,CAAC,CAAC8H,OAAhC,EAAyC,IAAzC,CAAb;;AAEA,UAAIoB,MAAJ,EAAY;AACVA,QAAAA,MAAM,CAAC/G,IAAP,GAAcsH,MAAd;AACA,eAAOP,MAAP;AACD;AACF;AACF;;AAED5J,EAAAA,QAAQ,CAACkK,QAAT,GAAoBD,WAApB;AACD,CAxBD;;AA0BApK,OAAO,CAAC6C,SAAR,CAAkBtB,WAAlB,GAAgC,UAAUV,CAAV,EAAa;AAC3C,MAAIoI,WAAW,GAAG,KAAKC,QAAvB;;AAEA,MAAID,WAAJ,EAAiB;AACf,SAAKL,cAAL,CAAoB,UAApB,EAAgC/H,CAAhC,EAAmC;AACjCyH,MAAAA,MAAM,EAAEW,WAAW,CAACX;AADa,KAAnC;AAGD;AACF,CARD;;AAUAtI,OAAO,CAAC6C,SAAR,CAAkB4F,UAAlB,GAA+B,UAAUnG,CAAV,EAAaC,CAAb,EAAgB;AAC7C,MAAIoI,MAAM,GAAG,EAAb;AACA,MAAIxK,QAAQ,GAAG,KAAKA,QAApB;AACA,MAAIiK,WAAW,GAAGjK,QAAQ,CAACkK,QAA3B;;AAEA,OAAK,IAAIxF,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1C,QAAIyF,MAAM,GAAG,KAAKxI,KAAL,CAAW+C,CAAX,CAAb;;AAEA,QAAIyF,MAAM,CAACE,YAAP,CAAoBlI,CAApB,EAAuBC,CAAvB,CAAJ,EAA+B;AAC7B,WAAKR,QAAL,CAAcuB,KAAd,GAAsBgH,MAAM,CAAChH,KAA7B;AACA,WAAKvB,QAAL,CAAc0I,MAAd,GAAuBH,MAAM,CAACG,MAA9B,CAF6B,CAES;AACtC;;AAEAtK,MAAAA,QAAQ,CAACkK,QAAT,GAAoBC,MAAM,CAACD,QAA3B;;AAEA,WAAKtI,QAAL,CAAc6I,OAAd,CAAsBtI,CAAtB,EAAyBC,CAAzB,EAA4BoI,MAA5B;AACD;AACF;;AAEDxK,EAAAA,QAAQ,CAACkK,QAAT,GAAoBD,WAApB;AACAO,EAAAA,MAAM,CAACE,IAAP,CAAY,UAAUC,CAAV,EAAaC,CAAb,EAAgB;AAC1B,WAAOD,CAAC,CAACX,QAAF,GAAaY,CAAC,CAACZ,QAAtB;AACD,GAFD;AAGA,SAAOQ,MAAM,CAAC,CAAD,CAAb;AACD,CAxBD;;AA0BA3K,OAAO,CAAC6C,SAAR,CAAkB+F,cAAlB,GAAmC,UAAUoC,OAAV,EAAmBC,aAAnB,EAAkCC,QAAlC,EAA4C;AAC7E,MAAI,CAACA,QAAL,EAAe;AACbA,IAAAA,QAAQ,GAAG,EAAX;AACD;;AAED,MAAIC,OAAO,GAAGD,QAAQ,CAAC5C,MAAvB;AACA4C,EAAAA,QAAQ,CAACE,YAAT,GAAwB,KAAxB;AACAF,EAAAA,QAAQ,CAAC3C,KAAT,GAAiB0C,aAAjB;AACAC,EAAAA,QAAQ,CAACpB,IAAT,GAAgBkB,OAAhB;AACAE,EAAAA,QAAQ,CAACxC,OAAT,GAAmBuC,aAAa,CAACvC,OAAjC;AACAwC,EAAAA,QAAQ,CAACvC,OAAT,GAAmBsC,aAAa,CAACtC,OAAjC;;AAEA,SAAOwC,OAAP,EAAgB;AACdA,IAAAA,OAAO,CAACE,OAAR,CAAgBL,OAAhB,EAAyBE,QAAzB;AACAC,IAAAA,OAAO,GAAGA,OAAO,CAACG,SAAR,EAAV;;AAEA,QAAIJ,QAAQ,CAACE,YAAb,EAA2B;AACzB;AACD;AACF;;AAED,OAAKG,eAAL,CAAqBP,OAArB,EAA8BE,QAA9B;AACD,CAtBD;;AAwBAlL,OAAO,CAAC6C,SAAR,CAAkBgG,kBAAlB,GAAuC,UAAUmC,OAAV,EAAmBC,aAAnB,EAAkCC,QAAlC,EAA4C;AACjF,MAAIM,IAAI,GAAGN,QAAQ,IAAIA,QAAQ,CAAC5C,MAAhC;AACA,MAAImD,SAAS,GAAGD,IAAI,IAAIA,IAAI,CAACC,SAA7B;AACA,MAAIC,WAAW,GAAGF,IAAI,IAAIA,IAAI,CAACE,WAA/B,CAHiF,CAGrC;;AAE5C,MAAIC,SAAS,GAAGH,IAAI,IAAIA,IAAI,CAACG,SAA7B;AACA,MAAIC,oBAAoB,GAAG,KAA3B;AACA,MAAIC,UAAU,GAAG,KAAK3J,aAAtB;AACA2J,EAAAA,UAAU,CAACvJ,CAAX,GAAe2I,aAAa,CAACvC,OAA7B;AACAmD,EAAAA,UAAU,CAACtJ,CAAX,GAAe0I,aAAa,CAACtC,OAA7B;AACAkD,EAAAA,UAAU,CAACC,MAAX;AACA,MAAIC,UAAU,GAAG;AACfzD,IAAAA,MAAM,EAAEuD;AADO,GAAjB;AAGA,MAAMG,MAAM,GAAGvM,OAAO,CAACwM,MAAR,CAAeC,SAAf,CAAyBL,UAAzB,CAAf;;AAEA,MAAIb,OAAO,KAAK,WAAhB,EAA6B;AAC3B,QAAIS,SAAS,IAAI,IAAjB,EAAuB;AACrB,UAAIA,SAAS,KAAK,KAAKU,cAAvB,EAAuC;AACrC,YAAIC,QAAQ,CAAC,KAAKD,cAAN,EAAsB,EAAtB,CAAR,IAAqC,CAAzC,EAA4C;AAC1CH,UAAAA,MAAM,CAACP,SAAP,GAAmB,KAAKU,cAAxB;AACAH,UAAAA,MAAM,CAACN,WAAP,GAAqB,KAAKW,gBAA1B,CAF0C,CAEE;;AAE5C,eAAKnM,EAAL,CAAQoM,OAAR,CAAgBC,iBAAhB,CAAkCR,UAAlC,EAA8C,UAA9C,EAA0Dd,aAA1D;AACD;;AAEDW,QAAAA,oBAAoB,GAAG,IAAvB;AACD;AACF,KAXD,MAWO,IAAID,SAAS,IAAI,IAAjB,EAAuB;AAC5B,UAAIA,SAAS,KAAK,KAAKa,cAAvB,EAAuC;AACrC,YAAI,KAAKA,cAAL,IAAuB,IAA3B,EAAiC;AAC/BR,UAAAA,MAAM,CAACL,SAAP,GAAmB,KAAKa,cAAxB,CAD+B,CACS;;AAExC,eAAKtM,EAAL,CAAQoM,OAAR,CAAgBC,iBAAhB,CAAkCR,UAAlC,EAA8C,UAA9C,EAA0Dd,aAA1D;AACD;;AAEDW,QAAAA,oBAAoB,GAAG,IAAvB;AACD;AACF;;AAED,SAAKY,cAAL,GAAsBb,SAAtB;AACA,SAAKQ,cAAL,GAAsBV,SAAtB;AACA,SAAKY,gBAAL,GAAwBX,WAAxB;AACD;;AAEDM,EAAAA,MAAM,CAACL,SAAP,GAAmBA,SAAnB;AACAK,EAAAA,MAAM,CAACP,SAAP,GAAmBA,SAAnB;AACAO,EAAAA,MAAM,CAACN,WAAP,GAAqBA,WAArB;;AAEA,MAAIC,SAAS,IAAI,IAAb,IAAqBS,QAAQ,CAACX,SAAD,EAAY,EAAZ,CAAR,IAA2B,CAA3B,IAAgCW,QAAQ,CAACV,WAAD,EAAc,EAAd,CAAR,IAA6B,CAAtF,EAAyF;AACvF,SAAKxL,EAAL,CAAQoM,OAAR,CAAgBC,iBAAhB,CAAkCR,UAAlC,EAA8Cf,OAA9C,EAAuDC,aAAvD;;AAEA,QAAIW,oBAAJ,EAA0B;AACxB,WAAK1L,EAAL,CAAQoM,OAAR,CAAgBC,iBAAhB,CAAkCR,UAAlC,EAA8C,WAA9C,EAA2Dd,aAA3D;AACD;AACF;AACF,CAxDD;;AA0DAjL,OAAO,CAAC6C,SAAR,CAAkB0I,eAAlB,GAAoC,UAAUkB,SAAV,EAAqB5L,CAArB,EAAwB;AAC1D,OAAK,IAAIgE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK/C,KAAL,CAAWkC,MAA/B,EAAuCa,CAAC,EAAxC,EAA4C;AAC1C,QAAI,KAAK/C,KAAL,CAAW+C,CAAX,EAAc2F,YAAd,CAA2B3J,CAAC,CAAC6H,OAA7B,EAAsC7H,CAAC,CAAC8H,OAAxC,CAAJ,EAAsD;AACpD,WAAK7G,KAAL,CAAW+C,CAAX,EAAcwG,OAAd,CAAsBoB,SAAtB,EAAiC5L,CAAjC;AACD;AACF;AACF,CAND;;AAQA6L,MAAM,CAACC,MAAP,CAAc3M,OAAO,CAAC6C,SAAtB,EAAiC/C,QAAjC;AACA,eAAeE,OAAf","sourcesContent":["/**\n * Provide WebGL layer to zrender. Which is rendered on top of clay.\n *\n *\n * Relationship between zrender, LayerGL(renderer) and ViewGL(Scene, Camera, Viewport)\n *           zrender\n *           /     \\\n *      LayerGL   LayerGL\n *    (renderer) (renderer)\n *      /     \\\n *  ViewGL   ViewGL\n */\nimport * as echarts from 'echarts/lib/echarts';\nimport Renderer from 'claygl/src/Renderer';\nimport RayPicking from 'claygl/src/picking/RayPicking';\nimport Texture from 'claygl/src/Texture';\nimport graphicGL from '../util/graphicGL'; // PENDING, clay. notifier is same with zrender Eventful\n\nimport notifier from 'claygl/src/core/mixin/notifier';\nimport requestAnimationFrame from 'zrender/lib/animation/requestAnimationFrame';\n/**\n * @constructor\n * @alias module:echarts-gl/core/LayerGL\n * @param {string} id Layer ID\n * @param {module:zrender/ZRender} zr\n */\n\nvar LayerGL = function (id, zr) {\n  /**\n   * Layer ID\n   * @type {string}\n   */\n  this.id = id;\n  /**\n   * @type {module:zrender/ZRender}\n   */\n\n  this.zr = zr;\n  /**\n   * @type {clay.Renderer}\n   */\n\n  try {\n    this.renderer = new Renderer({\n      clearBit: 0,\n      devicePixelRatio: zr.painter.dpr,\n      preserveDrawingBuffer: true,\n      // PENDING\n      premultipliedAlpha: true\n    });\n    this.renderer.resize(zr.painter.getWidth(), zr.painter.getHeight());\n  } catch (e) {\n    this.renderer = null;\n    this.dom = document.createElement('div');\n    this.dom.style.cssText = 'position:absolute; left: 0; top: 0; right: 0; bottom: 0;';\n    this.dom.className = 'ecgl-nowebgl';\n    this.dom.innerHTML = 'Sorry, your browser does not support WebGL';\n    console.error(e);\n    return;\n  }\n\n  this.onglobalout = this.onglobalout.bind(this);\n  zr.on('globalout', this.onglobalout);\n  /**\n   * Canvas dom for webgl rendering\n   * @type {HTMLCanvasElement}\n   */\n\n  this.dom = this.renderer.canvas;\n  var style = this.dom.style;\n  style.position = 'absolute';\n  style.left = '0';\n  style.top = '0';\n  /**\n   * @type {Array.<clay.Scene>}\n   */\n\n  this.views = [];\n  this._picking = new RayPicking({\n    renderer: this.renderer\n  });\n  this._viewsToDispose = [];\n  /**\n   * Current accumulating id.\n   */\n\n  this._accumulatingId = 0;\n  this._zrEventProxy = new echarts.graphic.Rect({\n    shape: {\n      x: -1,\n      y: -1,\n      width: 2,\n      height: 2\n    },\n    // FIXME Better solution.\n    __isGLToZRProxy: true\n  });\n  this._backgroundColor = null;\n  this._disposed = false;\n};\n\nLayerGL.prototype.setUnpainted = function () {};\n/**\n * @param {module:echarts-gl/core/ViewGL} view\n */\n\n\nLayerGL.prototype.addView = function (view) {\n  if (view.layer === this) {\n    return;\n  } // If needs to dispose in this layer. unmark it.\n\n\n  var idx = this._viewsToDispose.indexOf(view);\n\n  if (idx >= 0) {\n    this._viewsToDispose.splice(idx, 1);\n  }\n\n  this.views.push(view);\n  view.layer = this;\n  var zr = this.zr;\n  view.scene.traverse(function (node) {\n    node.__zr = zr;\n\n    if (node.addAnimatorsToZr) {\n      node.addAnimatorsToZr(zr);\n    }\n  });\n};\n\nfunction removeFromZr(node) {\n  var zr = node.__zr;\n  node.__zr = null;\n\n  if (zr && node.removeAnimatorsFromZr) {\n    node.removeAnimatorsFromZr(zr);\n  }\n}\n/**\n * @param {module:echarts-gl/core/ViewGL} view\n */\n\n\nLayerGL.prototype.removeView = function (view) {\n  if (view.layer !== this) {\n    return;\n  }\n\n  var idx = this.views.indexOf(view);\n\n  if (idx >= 0) {\n    this.views.splice(idx, 1);\n    view.scene.traverse(removeFromZr, this);\n    view.layer = null; // Mark to dispose in this layer.\n\n    this._viewsToDispose.push(view);\n  }\n};\n/**\n * Remove all views\n */\n\n\nLayerGL.prototype.removeViewsAll = function () {\n  this.views.forEach(function (view) {\n    view.scene.traverse(removeFromZr, this);\n    view.layer = null; // Mark to dispose in this layer.\n\n    this._viewsToDispose.push(view);\n  }, this);\n  this.views.length = 0;\n};\n/**\n * Resize the canvas and viewport, will be invoked by zrender\n * @param  {number} width\n * @param  {number} height\n */\n\n\nLayerGL.prototype.resize = function (width, height) {\n  var renderer = this.renderer;\n  renderer.resize(width, height);\n};\n/**\n * Clear color and depth\n * @return {[type]} [description]\n */\n\n\nLayerGL.prototype.clear = function () {\n  var gl = this.renderer.gl;\n  var clearColor = this._backgroundColor || [0, 0, 0, 0];\n  gl.clearColor(clearColor[0], clearColor[1], clearColor[2], clearColor[3]);\n  gl.depthMask(true);\n  gl.colorMask(true, true, true, true);\n  gl.clear(gl.DEPTH_BUFFER_BIT | gl.COLOR_BUFFER_BIT);\n};\n/**\n * Clear depth\n */\n\n\nLayerGL.prototype.clearDepth = function () {\n  var gl = this.renderer.gl;\n  gl.clear(gl.DEPTH_BUFFER_BIT);\n};\n/**\n * Clear color\n */\n\n\nLayerGL.prototype.clearColor = function () {\n  var gl = this.renderer.gl;\n  gl.clearColor(0, 0, 0, 0);\n  gl.clear(gl.COLOR_BUFFER_BIT);\n};\n/**\n * Mark layer to refresh next tick\n */\n\n\nLayerGL.prototype.needsRefresh = function () {\n  this.zr.refresh();\n};\n/**\n * Refresh the layer, will be invoked by zrender\n */\n\n\nLayerGL.prototype.refresh = function (bgColor) {\n  this._backgroundColor = bgColor ? graphicGL.parseColor(bgColor) : [0, 0, 0, 0];\n  this.renderer.clearColor = this._backgroundColor;\n\n  for (var i = 0; i < this.views.length; i++) {\n    this.views[i].prepareRender(this.renderer);\n  }\n\n  this._doRender(false); // Auto dispose unused resources on GPU, like program(shader), texture, geometry(buffers)\n\n\n  this._trackAndClean(); // Dispose trashed views\n\n\n  for (var i = 0; i < this._viewsToDispose.length; i++) {\n    this._viewsToDispose[i].dispose(this.renderer);\n  }\n\n  this._viewsToDispose.length = 0;\n\n  this._startAccumulating();\n};\n\nLayerGL.prototype.renderToCanvas = function (ctx) {\n  // PENDING will block the page\n  this._startAccumulating(true);\n\n  ctx.drawImage(this.dom, 0, 0, ctx.canvas.width, ctx.canvas.height);\n};\n\nLayerGL.prototype._doRender = function (accumulating) {\n  this.clear();\n  this.renderer.saveViewport();\n\n  for (var i = 0; i < this.views.length; i++) {\n    this.views[i].render(this.renderer, accumulating);\n  }\n\n  this.renderer.restoreViewport();\n};\n/**\n * Stop accumulating\n */\n\n\nLayerGL.prototype._stopAccumulating = function () {\n  this._accumulatingId = 0;\n  clearTimeout(this._accumulatingTimeout);\n};\n\nvar accumulatingId = 1;\n/**\n * Start accumulating all the views.\n * Accumulating is for antialising and have more sampling in SSAO\n * @private\n */\n\nLayerGL.prototype._startAccumulating = function (immediate) {\n  var self = this;\n\n  this._stopAccumulating();\n\n  var needsAccumulate = false;\n\n  for (var i = 0; i < this.views.length; i++) {\n    needsAccumulate = this.views[i].needsAccumulate() || needsAccumulate;\n  }\n\n  if (!needsAccumulate) {\n    return;\n  }\n\n  function accumulate(id) {\n    if (!self._accumulatingId || id !== self._accumulatingId) {\n      return;\n    }\n\n    var isFinished = true;\n\n    for (var i = 0; i < self.views.length; i++) {\n      isFinished = self.views[i].isAccumulateFinished() && needsAccumulate;\n    }\n\n    if (!isFinished) {\n      self._doRender(true);\n\n      if (immediate) {\n        accumulate(id);\n      } else {\n        requestAnimationFrame(function () {\n          accumulate(id);\n        });\n      }\n    }\n  }\n\n  this._accumulatingId = accumulatingId++;\n\n  if (immediate) {\n    accumulate(self._accumulatingId);\n  } else {\n    this._accumulatingTimeout = setTimeout(function () {\n      accumulate(self._accumulatingId);\n    }, 50);\n  }\n};\n\nLayerGL.prototype._trackAndClean = function () {\n  var textureList = [];\n  var geometriesList = []; // Mark all resources unused;\n\n  if (this._textureList) {\n    markUnused(this._textureList);\n    markUnused(this._geometriesList);\n  }\n\n  for (var i = 0; i < this.views.length; i++) {\n    collectResources(this.views[i].scene, textureList, geometriesList);\n  } // Dispose those unsed resources.\n\n\n  if (this._textureList) {\n    checkAndDispose(this.renderer, this._textureList);\n    checkAndDispose(this.renderer, this._geometriesList);\n  }\n\n  this._textureList = textureList;\n  this._geometriesList = geometriesList;\n};\n\nfunction markUnused(resourceList) {\n  for (var i = 0; i < resourceList.length; i++) {\n    resourceList[i].__used__ = 0;\n  }\n}\n\nfunction checkAndDispose(renderer, resourceList) {\n  for (var i = 0; i < resourceList.length; i++) {\n    if (!resourceList[i].__used__) {\n      resourceList[i].dispose(renderer);\n    }\n  }\n}\n\nfunction updateUsed(resource, list) {\n  resource.__used__ = resource.__used__ || 0;\n  resource.__used__++;\n\n  if (resource.__used__ === 1) {\n    // Don't push to the list twice.\n    list.push(resource);\n  }\n}\n\nfunction collectResources(scene, textureResourceList, geometryResourceList) {\n  var prevMaterial;\n  var prevGeometry;\n  scene.traverse(function (renderable) {\n    if (renderable.isRenderable()) {\n      var geometry = renderable.geometry;\n      var material = renderable.material; // TODO optimize!!\n\n      if (material !== prevMaterial) {\n        var textureUniforms = material.getTextureUniforms();\n\n        for (var u = 0; u < textureUniforms.length; u++) {\n          var uniformName = textureUniforms[u];\n          var val = material.uniforms[uniformName].value;\n\n          if (!val) {\n            continue;\n          }\n\n          if (val instanceof Texture) {\n            updateUsed(val, textureResourceList);\n          } else if (val instanceof Array) {\n            for (var k = 0; k < val.length; k++) {\n              if (val[k] instanceof Texture) {\n                updateUsed(val[k], textureResourceList);\n              }\n            }\n          }\n        }\n      }\n\n      if (geometry !== prevGeometry) {\n        updateUsed(geometry, geometryResourceList);\n      }\n\n      prevMaterial = material;\n      prevGeometry = geometry;\n    }\n  });\n\n  for (var k = 0; k < scene.lights.length; k++) {\n    // Track AmbientCubemap\n    if (scene.lights[k].cubemap) {\n      updateUsed(scene.lights[k].cubemap, textureResourceList);\n    }\n  }\n}\n/**\n * Dispose the layer\n */\n\n\nLayerGL.prototype.dispose = function () {\n  if (this._disposed) {\n    return;\n  }\n\n  this._stopAccumulating();\n\n  if (this._textureList) {\n    markUnused(this._textureList);\n    markUnused(this._geometriesList);\n    checkAndDispose(this.renderer, this._textureList);\n    checkAndDispose(this.renderer, this._geometriesList);\n  }\n\n  this.zr.off('globalout', this.onglobalout);\n  this._disposed = true;\n}; // Event handlers\n\n\nLayerGL.prototype.onmousedown = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n\n  if (obj) {\n    this._dispatchEvent('mousedown', e, obj);\n\n    this._dispatchDataEvent('mousedown', e, obj);\n  }\n\n  this._downX = e.offsetX;\n  this._downY = e.offsetY;\n};\n\nLayerGL.prototype.onmousemove = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n  var target = obj && obj.target;\n  var lastHovered = this._hovered;\n  this._hovered = obj;\n\n  if (lastHovered && target !== lastHovered.target) {\n    lastHovered.relatedTarget = target;\n\n    this._dispatchEvent('mouseout', e, lastHovered); // this._dispatchDataEvent('mouseout', e, lastHovered);\n\n\n    this.zr.setCursorStyle('default');\n  }\n\n  this._dispatchEvent('mousemove', e, obj);\n\n  if (obj) {\n    this.zr.setCursorStyle('pointer');\n\n    if (!lastHovered || target !== lastHovered.target) {\n      this._dispatchEvent('mouseover', e, obj); // this._dispatchDataEvent('mouseover', e, obj);\n\n    }\n  }\n\n  this._dispatchDataEvent('mousemove', e, obj);\n};\n\nLayerGL.prototype.onmouseup = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n\n  if (obj) {\n    this._dispatchEvent('mouseup', e, obj);\n\n    this._dispatchDataEvent('mouseup', e, obj);\n  }\n\n  this._upX = e.offsetX;\n  this._upY = e.offsetY;\n};\n\nLayerGL.prototype.onclick = LayerGL.prototype.dblclick = function (e) {\n  if (e.target && e.target.__isGLToZRProxy) {\n    return;\n  } // Ignore click event if mouse moved\n\n\n  var dx = this._upX - this._downX;\n  var dy = this._upY - this._downY;\n\n  if (Math.sqrt(dx * dx + dy * dy) > 20) {\n    return;\n  }\n\n  e = e.event;\n  var obj = this.pickObject(e.offsetX, e.offsetY);\n\n  if (obj) {\n    this._dispatchEvent(e.type, e, obj);\n\n    this._dispatchDataEvent(e.type, e, obj);\n  } // Try set depth of field onclick\n\n\n  var result = this._clickToSetFocusPoint(e);\n\n  if (result) {\n    var success = result.view.setDOFFocusOnPoint(result.distance);\n\n    if (success) {\n      this.zr.refresh();\n    }\n  }\n};\n\nLayerGL.prototype._clickToSetFocusPoint = function (e) {\n  var renderer = this.renderer;\n  var oldViewport = renderer.viewport;\n\n  for (var i = this.views.length - 1; i >= 0; i--) {\n    var viewGL = this.views[i];\n\n    if (viewGL.hasDOF() && viewGL.containPoint(e.offsetX, e.offsetY)) {\n      this._picking.scene = viewGL.scene;\n      this._picking.camera = viewGL.camera; // Only used for picking, renderer.setViewport will also invoke gl.viewport.\n      // Set directly, PENDING.\n\n      renderer.viewport = viewGL.viewport;\n\n      var result = this._picking.pick(e.offsetX, e.offsetY, true);\n\n      if (result) {\n        result.view = viewGL;\n        return result;\n      }\n    }\n  }\n\n  renderer.viewport = oldViewport;\n};\n\nLayerGL.prototype.onglobalout = function (e) {\n  var lastHovered = this._hovered;\n\n  if (lastHovered) {\n    this._dispatchEvent('mouseout', e, {\n      target: lastHovered.target\n    });\n  }\n};\n\nLayerGL.prototype.pickObject = function (x, y) {\n  var output = [];\n  var renderer = this.renderer;\n  var oldViewport = renderer.viewport;\n\n  for (var i = 0; i < this.views.length; i++) {\n    var viewGL = this.views[i];\n\n    if (viewGL.containPoint(x, y)) {\n      this._picking.scene = viewGL.scene;\n      this._picking.camera = viewGL.camera; // Only used for picking, renderer.setViewport will also invoke gl.viewport.\n      // Set directly, PENDING.\n\n      renderer.viewport = viewGL.viewport;\n\n      this._picking.pickAll(x, y, output);\n    }\n  }\n\n  renderer.viewport = oldViewport;\n  output.sort(function (a, b) {\n    return a.distance - b.distance;\n  });\n  return output[0];\n};\n\nLayerGL.prototype._dispatchEvent = function (eveName, originalEvent, newEvent) {\n  if (!newEvent) {\n    newEvent = {};\n  }\n\n  var current = newEvent.target;\n  newEvent.cancelBubble = false;\n  newEvent.event = originalEvent;\n  newEvent.type = eveName;\n  newEvent.offsetX = originalEvent.offsetX;\n  newEvent.offsetY = originalEvent.offsetY;\n\n  while (current) {\n    current.trigger(eveName, newEvent);\n    current = current.getParent();\n\n    if (newEvent.cancelBubble) {\n      break;\n    }\n  }\n\n  this._dispatchToView(eveName, newEvent);\n};\n\nLayerGL.prototype._dispatchDataEvent = function (eveName, originalEvent, newEvent) {\n  var mesh = newEvent && newEvent.target;\n  var dataIndex = mesh && mesh.dataIndex;\n  var seriesIndex = mesh && mesh.seriesIndex; // Custom event data\n\n  var eventData = mesh && mesh.eventData;\n  var elChangedInMouseMove = false;\n  var eventProxy = this._zrEventProxy;\n  eventProxy.x = originalEvent.offsetX;\n  eventProxy.y = originalEvent.offsetY;\n  eventProxy.update();\n  var targetInfo = {\n    target: eventProxy\n  };\n  const ecData = echarts.helper.getECData(eventProxy);\n\n  if (eveName === 'mousemove') {\n    if (dataIndex != null) {\n      if (dataIndex !== this._lastDataIndex) {\n        if (parseInt(this._lastDataIndex, 10) >= 0) {\n          ecData.dataIndex = this._lastDataIndex;\n          ecData.seriesIndex = this._lastSeriesIndex; // FIXME May cause double events.\n\n          this.zr.handler.dispatchToElement(targetInfo, 'mouseout', originalEvent);\n        }\n\n        elChangedInMouseMove = true;\n      }\n    } else if (eventData != null) {\n      if (eventData !== this._lastEventData) {\n        if (this._lastEventData != null) {\n          ecData.eventData = this._lastEventData; // FIXME May cause double events.\n\n          this.zr.handler.dispatchToElement(targetInfo, 'mouseout', originalEvent);\n        }\n\n        elChangedInMouseMove = true;\n      }\n    }\n\n    this._lastEventData = eventData;\n    this._lastDataIndex = dataIndex;\n    this._lastSeriesIndex = seriesIndex;\n  }\n\n  ecData.eventData = eventData;\n  ecData.dataIndex = dataIndex;\n  ecData.seriesIndex = seriesIndex;\n\n  if (eventData != null || parseInt(dataIndex, 10) >= 0 && parseInt(seriesIndex, 10) >= 0) {\n    this.zr.handler.dispatchToElement(targetInfo, eveName, originalEvent);\n\n    if (elChangedInMouseMove) {\n      this.zr.handler.dispatchToElement(targetInfo, 'mouseover', originalEvent);\n    }\n  }\n};\n\nLayerGL.prototype._dispatchToView = function (eventName, e) {\n  for (var i = 0; i < this.views.length; i++) {\n    if (this.views[i].containPoint(e.offsetX, e.offsetY)) {\n      this.views[i].trigger(eventName, e);\n    }\n  }\n};\n\nObject.assign(LayerGL.prototype, notifier);\nexport default LayerGL;"]},"metadata":{},"sourceType":"module"}