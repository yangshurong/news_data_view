{"ast":null,"code":"import \"core-js/modules/es.typed-array.at.js\";\nimport \"core-js/modules/es.typed-array.set.js\";\nimport vendor from '../core/vendor';\nimport Base from '../core/Base';\nvar SHADER_STATE_TO_ENABLE = 1;\nvar SHADER_STATE_KEEP_ENABLE = 2;\nvar SHADER_STATE_PENDING = 3; // Enable attribute operation is global to all programs\n// Here saved the list of all enabled attribute index\n// http://www.mjbshaw.com/2013/03/webgl-fixing-invalidoperation.html\n\nvar enabledAttributeList = {}; // some util functions\n\nfunction addLineNumbers(string) {\n  var chunks = string.split('\\n');\n\n  for (var i = 0, il = chunks.length; i < il; i++) {\n    // Chrome reports shader errors on lines\n    // starting counting from 1\n    chunks[i] = i + 1 + ': ' + chunks[i];\n  }\n\n  return chunks.join('\\n');\n} // Return true or error msg if error happened\n\n\nfunction checkShaderErrorMsg(_gl, shader, shaderString) {\n  if (!_gl.getShaderParameter(shader, _gl.COMPILE_STATUS)) {\n    return [_gl.getShaderInfoLog(shader), addLineNumbers(shaderString)].join('\\n');\n  }\n}\n\nvar tmpFloat32Array16 = new vendor.Float32Array(16);\nvar GLProgram = Base.extend({\n  uniformSemantics: {},\n  attributes: {}\n}, function () {\n  this._locations = {};\n  this._textureSlot = 0;\n  this._program = null;\n}, {\n  bind: function (renderer) {\n    this._textureSlot = 0;\n    renderer.gl.useProgram(this._program);\n  },\n  hasUniform: function (symbol) {\n    var location = this._locations[symbol];\n    return location !== null && location !== undefined;\n  },\n  useTextureSlot: function (renderer, texture, slot) {\n    if (texture) {\n      renderer.gl.activeTexture(renderer.gl.TEXTURE0 + slot); // Maybe texture is not loaded yet;\n\n      if (texture.isRenderable()) {\n        texture.bind(renderer);\n      } else {\n        // Bind texture to null\n        texture.unbind(renderer);\n      }\n    }\n  },\n  currentTextureSlot: function () {\n    return this._textureSlot;\n  },\n  resetTextureSlot: function (slot) {\n    this._textureSlot = slot || 0;\n  },\n  takeCurrentTextureSlot: function (renderer, texture) {\n    var textureSlot = this._textureSlot;\n    this.useTextureSlot(renderer, texture, textureSlot);\n    this._textureSlot++;\n    return textureSlot;\n  },\n  setUniform: function (_gl, type, symbol, value) {\n    var locationMap = this._locations;\n    var location = locationMap[symbol]; // Uniform is not existed in the shader\n\n    if (location === null || location === undefined) {\n      return false;\n    }\n\n    switch (type) {\n      case 'm4':\n        if (!(value instanceof Float32Array)) {\n          // Use Float32Array is much faster than array when uniformMatrix4fv.\n          for (var i = 0; i < value.length; i++) {\n            tmpFloat32Array16[i] = value[i];\n          }\n\n          value = tmpFloat32Array16;\n        }\n\n        _gl.uniformMatrix4fv(location, false, value);\n\n        break;\n\n      case '2i':\n        _gl.uniform2i(location, value[0], value[1]);\n\n        break;\n\n      case '2f':\n        _gl.uniform2f(location, value[0], value[1]);\n\n        break;\n\n      case '3i':\n        _gl.uniform3i(location, value[0], value[1], value[2]);\n\n        break;\n\n      case '3f':\n        _gl.uniform3f(location, value[0], value[1], value[2]);\n\n        break;\n\n      case '4i':\n        _gl.uniform4i(location, value[0], value[1], value[2], value[3]);\n\n        break;\n\n      case '4f':\n        _gl.uniform4f(location, value[0], value[1], value[2], value[3]);\n\n        break;\n\n      case '1i':\n        _gl.uniform1i(location, value);\n\n        break;\n\n      case '1f':\n        _gl.uniform1f(location, value);\n\n        break;\n\n      case '1fv':\n        _gl.uniform1fv(location, value);\n\n        break;\n\n      case '1iv':\n        _gl.uniform1iv(location, value);\n\n        break;\n\n      case '2iv':\n        _gl.uniform2iv(location, value);\n\n        break;\n\n      case '2fv':\n        _gl.uniform2fv(location, value);\n\n        break;\n\n      case '3iv':\n        _gl.uniform3iv(location, value);\n\n        break;\n\n      case '3fv':\n        _gl.uniform3fv(location, value);\n\n        break;\n\n      case '4iv':\n        _gl.uniform4iv(location, value);\n\n        break;\n\n      case '4fv':\n        _gl.uniform4fv(location, value);\n\n        break;\n\n      case 'm2':\n      case 'm2v':\n        _gl.uniformMatrix2fv(location, false, value);\n\n        break;\n\n      case 'm3':\n      case 'm3v':\n        _gl.uniformMatrix3fv(location, false, value);\n\n        break;\n\n      case 'm4v':\n        // Raw value\n        if (Array.isArray(value) && Array.isArray(value[0])) {\n          var array = new vendor.Float32Array(value.length * 16);\n          var cursor = 0;\n\n          for (var i = 0; i < value.length; i++) {\n            var item = value[i];\n\n            for (var j = 0; j < 16; j++) {\n              array[cursor++] = item[j];\n            }\n          }\n\n          _gl.uniformMatrix4fv(location, false, array);\n        } else {\n          // ArrayBufferView\n          _gl.uniformMatrix4fv(location, false, value);\n        }\n\n        break;\n    }\n\n    return true;\n  },\n  setUniformOfSemantic: function (_gl, semantic, val) {\n    var semanticInfo = this.uniformSemantics[semantic];\n\n    if (semanticInfo) {\n      return this.setUniform(_gl, semanticInfo.type, semanticInfo.symbol, val);\n    }\n\n    return false;\n  },\n  // Used for creating VAO\n  // Enable the attributes passed in and disable the rest\n  // Example Usage:\n  // enableAttributes(renderer, [\"position\", \"texcoords\"])\n  enableAttributes: function (renderer, attribList, vao) {\n    var _gl = renderer.gl;\n    var program = this._program;\n    var locationMap = this._locations;\n    var enabledAttributeListInContext;\n\n    if (vao) {\n      enabledAttributeListInContext = vao.__enabledAttributeList;\n    } else {\n      enabledAttributeListInContext = enabledAttributeList[renderer.__uid__];\n    }\n\n    if (!enabledAttributeListInContext) {\n      // In vertex array object context\n      // PENDING Each vao object needs to enable attributes again?\n      if (vao) {\n        enabledAttributeListInContext = vao.__enabledAttributeList = [];\n      } else {\n        enabledAttributeListInContext = enabledAttributeList[renderer.__uid__] = [];\n      }\n    }\n\n    var locationList = [];\n\n    for (var i = 0; i < attribList.length; i++) {\n      var symbol = attribList[i];\n\n      if (!this.attributes[symbol]) {\n        locationList[i] = -1;\n        continue;\n      }\n\n      var location = locationMap[symbol];\n\n      if (location == null) {\n        location = _gl.getAttribLocation(program, symbol); // Attrib location is a number from 0 to ...\n\n        if (location === -1) {\n          locationList[i] = -1;\n          continue;\n        }\n\n        locationMap[symbol] = location;\n      }\n\n      locationList[i] = location;\n\n      if (!enabledAttributeListInContext[location]) {\n        enabledAttributeListInContext[location] = SHADER_STATE_TO_ENABLE;\n      } else {\n        enabledAttributeListInContext[location] = SHADER_STATE_KEEP_ENABLE;\n      }\n    }\n\n    for (var i = 0; i < enabledAttributeListInContext.length; i++) {\n      switch (enabledAttributeListInContext[i]) {\n        case SHADER_STATE_TO_ENABLE:\n          _gl.enableVertexAttribArray(i);\n\n          enabledAttributeListInContext[i] = SHADER_STATE_PENDING;\n          break;\n\n        case SHADER_STATE_KEEP_ENABLE:\n          enabledAttributeListInContext[i] = SHADER_STATE_PENDING;\n          break;\n        // Expired\n\n        case SHADER_STATE_PENDING:\n          _gl.disableVertexAttribArray(i);\n\n          enabledAttributeListInContext[i] = 0;\n          break;\n      }\n    }\n\n    return locationList;\n  },\n  getAttribLocation: function (_gl, symbol) {\n    var locationMap = this._locations;\n    var location = locationMap[symbol];\n\n    if (location == null) {\n      location = _gl.getAttribLocation(this._program, symbol);\n      locationMap[symbol] = location;\n    }\n\n    return location;\n  },\n  buildProgram: function (_gl, shader, vertexShaderCode, fragmentShaderCode) {\n    var vertexShader = _gl.createShader(_gl.VERTEX_SHADER);\n\n    var program = _gl.createProgram();\n\n    _gl.shaderSource(vertexShader, vertexShaderCode);\n\n    _gl.compileShader(vertexShader);\n\n    var fragmentShader = _gl.createShader(_gl.FRAGMENT_SHADER);\n\n    _gl.shaderSource(fragmentShader, fragmentShaderCode);\n\n    _gl.compileShader(fragmentShader);\n\n    var msg = checkShaderErrorMsg(_gl, vertexShader, vertexShaderCode);\n\n    if (msg) {\n      return msg;\n    }\n\n    msg = checkShaderErrorMsg(_gl, fragmentShader, fragmentShaderCode);\n\n    if (msg) {\n      return msg;\n    }\n\n    _gl.attachShader(program, vertexShader);\n\n    _gl.attachShader(program, fragmentShader); // Force the position bind to location 0;\n\n\n    if (shader.attributeSemantics['POSITION']) {\n      _gl.bindAttribLocation(program, 0, shader.attributeSemantics['POSITION'].symbol);\n    } else {\n      // Else choose an attribute and bind to location 0;\n      var keys = Object.keys(this.attributes);\n\n      _gl.bindAttribLocation(program, 0, keys[0]);\n    }\n\n    _gl.linkProgram(program);\n\n    _gl.deleteShader(vertexShader);\n\n    _gl.deleteShader(fragmentShader);\n\n    this._program = program; // Save code.\n\n    this.vertexCode = vertexShaderCode;\n    this.fragmentCode = fragmentShaderCode;\n\n    if (!_gl.getProgramParameter(program, _gl.LINK_STATUS)) {\n      return 'Could not link program\\n' + _gl.getProgramInfoLog(program);\n    } // Cache uniform locations\n\n\n    for (var i = 0; i < shader.uniforms.length; i++) {\n      var uniformSymbol = shader.uniforms[i];\n      this._locations[uniformSymbol] = _gl.getUniformLocation(program, uniformSymbol);\n    }\n  }\n});\nexport default GLProgram;","map":{"version":3,"sources":["C:/Users/Administrator/Desktop/data_view/my_project/vue2_app/myapp/node_modules/claygl/src/gpu/GLProgram.js"],"names":["vendor","Base","SHADER_STATE_TO_ENABLE","SHADER_STATE_KEEP_ENABLE","SHADER_STATE_PENDING","enabledAttributeList","addLineNumbers","string","chunks","split","i","il","length","join","checkShaderErrorMsg","_gl","shader","shaderString","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","tmpFloat32Array16","Float32Array","GLProgram","extend","uniformSemantics","attributes","_locations","_textureSlot","_program","bind","renderer","gl","useProgram","hasUniform","symbol","location","undefined","useTextureSlot","texture","slot","activeTexture","TEXTURE0","isRenderable","unbind","currentTextureSlot","resetTextureSlot","takeCurrentTextureSlot","textureSlot","setUniform","type","value","locationMap","uniformMatrix4fv","uniform2i","uniform2f","uniform3i","uniform3f","uniform4i","uniform4f","uniform1i","uniform1f","uniform1fv","uniform1iv","uniform2iv","uniform2fv","uniform3iv","uniform3fv","uniform4iv","uniform4fv","uniformMatrix2fv","uniformMatrix3fv","Array","isArray","array","cursor","item","j","setUniformOfSemantic","semantic","val","semanticInfo","enableAttributes","attribList","vao","program","enabledAttributeListInContext","__enabledAttributeList","__uid__","locationList","getAttribLocation","enableVertexAttribArray","disableVertexAttribArray","buildProgram","vertexShaderCode","fragmentShaderCode","vertexShader","createShader","VERTEX_SHADER","createProgram","shaderSource","compileShader","fragmentShader","FRAGMENT_SHADER","msg","attachShader","attributeSemantics","bindAttribLocation","keys","Object","linkProgram","deleteShader","vertexCode","fragmentCode","getProgramParameter","LINK_STATUS","getProgramInfoLog","uniforms","uniformSymbol","getUniformLocation"],"mappings":"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","sourcesContent":["import vendor from '../core/vendor';\nimport Base from '../core/Base';\n\nvar SHADER_STATE_TO_ENABLE = 1;\nvar SHADER_STATE_KEEP_ENABLE = 2;\nvar SHADER_STATE_PENDING = 3;\n\n// Enable attribute operation is global to all programs\n// Here saved the list of all enabled attribute index\n// http://www.mjbshaw.com/2013/03/webgl-fixing-invalidoperation.html\nvar enabledAttributeList = {};\n\n// some util functions\nfunction addLineNumbers(string) {\n    var chunks = string.split('\\n');\n    for (var i = 0, il = chunks.length; i < il; i ++) {\n        // Chrome reports shader errors on lines\n        // starting counting from 1\n        chunks[i] = (i + 1) + ': ' + chunks[i];\n    }\n    return chunks.join('\\n');\n}\n\n// Return true or error msg if error happened\nfunction checkShaderErrorMsg(_gl, shader, shaderString) {\n    if (!_gl.getShaderParameter(shader, _gl.COMPILE_STATUS)) {\n        return [_gl.getShaderInfoLog(shader), addLineNumbers(shaderString)].join('\\n');\n    }\n}\n\nvar tmpFloat32Array16 = new vendor.Float32Array(16);\n\nvar GLProgram = Base.extend({\n\n    uniformSemantics: {},\n    attributes: {}\n\n}, function () {\n    this._locations = {};\n\n    this._textureSlot = 0;\n\n    this._program = null;\n}, {\n\n    bind: function (renderer) {\n        this._textureSlot = 0;\n        renderer.gl.useProgram(this._program);\n    },\n\n    hasUniform: function (symbol) {\n        var location = this._locations[symbol];\n        return location !== null && location !== undefined;\n    },\n\n    useTextureSlot: function (renderer, texture, slot) {\n        if (texture) {\n            renderer.gl.activeTexture(renderer.gl.TEXTURE0 + slot);\n            // Maybe texture is not loaded yet;\n            if (texture.isRenderable()) {\n                texture.bind(renderer);\n            }\n            else {\n                // Bind texture to null\n                texture.unbind(renderer);\n            }\n        }\n    },\n\n    currentTextureSlot: function () {\n        return this._textureSlot;\n    },\n\n    resetTextureSlot: function (slot) {\n        this._textureSlot = slot || 0;\n    },\n\n    takeCurrentTextureSlot: function (renderer, texture) {\n        var textureSlot = this._textureSlot;\n\n        this.useTextureSlot(renderer, texture, textureSlot);\n\n        this._textureSlot++;\n\n        return textureSlot;\n    },\n\n    setUniform: function (_gl, type, symbol, value) {\n        var locationMap = this._locations;\n        var location = locationMap[symbol];\n        // Uniform is not existed in the shader\n        if (location === null || location === undefined) {\n            return false;\n        }\n\n        switch (type) {\n            case 'm4':\n                if (!(value instanceof Float32Array)) {\n                    // Use Float32Array is much faster than array when uniformMatrix4fv.\n                    for (var i = 0; i < value.length; i++) {\n                        tmpFloat32Array16[i] = value[i];\n                    }\n                    value = tmpFloat32Array16;\n                }\n                _gl.uniformMatrix4fv(location, false, value);\n                break;\n            case '2i':\n                _gl.uniform2i(location, value[0], value[1]);\n                break;\n            case '2f':\n                _gl.uniform2f(location, value[0], value[1]);\n                break;\n            case '3i':\n                _gl.uniform3i(location, value[0], value[1], value[2]);\n                break;\n            case '3f':\n                _gl.uniform3f(location, value[0], value[1], value[2]);\n                break;\n            case '4i':\n                _gl.uniform4i(location, value[0], value[1], value[2], value[3]);\n                break;\n            case '4f':\n                _gl.uniform4f(location, value[0], value[1], value[2], value[3]);\n                break;\n            case '1i':\n                _gl.uniform1i(location, value);\n                break;\n            case '1f':\n                _gl.uniform1f(location, value);\n                break;\n            case '1fv':\n                _gl.uniform1fv(location, value);\n                break;\n            case '1iv':\n                _gl.uniform1iv(location, value);\n                break;\n            case '2iv':\n                _gl.uniform2iv(location, value);\n                break;\n            case '2fv':\n                _gl.uniform2fv(location, value);\n                break;\n            case '3iv':\n                _gl.uniform3iv(location, value);\n                break;\n            case '3fv':\n                _gl.uniform3fv(location, value);\n                break;\n            case '4iv':\n                _gl.uniform4iv(location, value);\n                break;\n            case '4fv':\n                _gl.uniform4fv(location, value);\n                break;\n            case 'm2':\n            case 'm2v':\n                _gl.uniformMatrix2fv(location, false, value);\n                break;\n            case 'm3':\n            case 'm3v':\n                _gl.uniformMatrix3fv(location, false, value);\n                break;\n            case 'm4v':\n                // Raw value\n                if (Array.isArray(value) && Array.isArray(value[0])) {\n                    var array = new vendor.Float32Array(value.length * 16);\n                    var cursor = 0;\n                    for (var i = 0; i < value.length; i++) {\n                        var item = value[i];\n                        for (var j = 0; j < 16; j++) {\n                            array[cursor++] = item[j];\n                        }\n                    }\n                    _gl.uniformMatrix4fv(location, false, array);\n                }\n                else {   // ArrayBufferView\n                    _gl.uniformMatrix4fv(location, false, value);\n                }\n                break;\n        }\n        return true;\n    },\n\n    setUniformOfSemantic: function (_gl, semantic, val) {\n        var semanticInfo = this.uniformSemantics[semantic];\n        if (semanticInfo) {\n            return this.setUniform(_gl, semanticInfo.type, semanticInfo.symbol, val);\n        }\n        return false;\n    },\n\n    // Used for creating VAO\n    // Enable the attributes passed in and disable the rest\n    // Example Usage:\n    // enableAttributes(renderer, [\"position\", \"texcoords\"])\n    enableAttributes: function (renderer, attribList, vao) {\n        var _gl = renderer.gl;\n        var program = this._program;\n\n        var locationMap = this._locations;\n\n        var enabledAttributeListInContext;\n        if (vao) {\n            enabledAttributeListInContext = vao.__enabledAttributeList;\n        }\n        else {\n            enabledAttributeListInContext = enabledAttributeList[renderer.__uid__];\n        }\n        if (!enabledAttributeListInContext) {\n            // In vertex array object context\n            // PENDING Each vao object needs to enable attributes again?\n            if (vao) {\n                enabledAttributeListInContext\n                    = vao.__enabledAttributeList\n                    = [];\n            }\n            else {\n                enabledAttributeListInContext\n                    = enabledAttributeList[renderer.__uid__]\n                    = [];\n            }\n        }\n        var locationList = [];\n        for (var i = 0; i < attribList.length; i++) {\n            var symbol = attribList[i];\n            if (!this.attributes[symbol]) {\n                locationList[i] = -1;\n                continue;\n            }\n            var location = locationMap[symbol];\n            if (location == null) {\n                location = _gl.getAttribLocation(program, symbol);\n                // Attrib location is a number from 0 to ...\n                if (location === -1) {\n                    locationList[i] = -1;\n                    continue;\n                }\n                locationMap[symbol] = location;\n            }\n            locationList[i] = location;\n\n            if (!enabledAttributeListInContext[location]) {\n                enabledAttributeListInContext[location] = SHADER_STATE_TO_ENABLE;\n            }\n            else {\n                enabledAttributeListInContext[location] = SHADER_STATE_KEEP_ENABLE;\n            }\n        }\n\n        for (var i = 0; i < enabledAttributeListInContext.length; i++) {\n            switch(enabledAttributeListInContext[i]){\n                case SHADER_STATE_TO_ENABLE:\n                    _gl.enableVertexAttribArray(i);\n                    enabledAttributeListInContext[i] = SHADER_STATE_PENDING;\n                    break;\n                case SHADER_STATE_KEEP_ENABLE:\n                    enabledAttributeListInContext[i] = SHADER_STATE_PENDING;\n                    break;\n                // Expired\n                case SHADER_STATE_PENDING:\n                    _gl.disableVertexAttribArray(i);\n                    enabledAttributeListInContext[i] = 0;\n                    break;\n            }\n        }\n\n        return locationList;\n    },\n\n    getAttribLocation: function (_gl, symbol) {\n        var locationMap = this._locations;\n\n        var location = locationMap[symbol];\n        if (location == null) {\n            location = _gl.getAttribLocation(this._program, symbol);\n            locationMap[symbol] = location;\n        }\n\n        return location;\n    },\n\n    buildProgram: function (_gl, shader, vertexShaderCode, fragmentShaderCode) {\n        var vertexShader = _gl.createShader(_gl.VERTEX_SHADER);\n        var program = _gl.createProgram();\n\n        _gl.shaderSource(vertexShader, vertexShaderCode);\n        _gl.compileShader(vertexShader);\n\n        var fragmentShader = _gl.createShader(_gl.FRAGMENT_SHADER);\n        _gl.shaderSource(fragmentShader, fragmentShaderCode);\n        _gl.compileShader(fragmentShader);\n\n        var msg = checkShaderErrorMsg(_gl, vertexShader, vertexShaderCode);\n        if (msg) {\n            return msg;\n        }\n        msg = checkShaderErrorMsg(_gl, fragmentShader, fragmentShaderCode);\n        if (msg) {\n            return msg;\n        }\n\n        _gl.attachShader(program, vertexShader);\n        _gl.attachShader(program, fragmentShader);\n        // Force the position bind to location 0;\n        if (shader.attributeSemantics['POSITION']) {\n            _gl.bindAttribLocation(program, 0, shader.attributeSemantics['POSITION'].symbol);\n        }\n        else {\n            // Else choose an attribute and bind to location 0;\n            var keys = Object.keys(this.attributes);\n            _gl.bindAttribLocation(program, 0, keys[0]);\n        }\n\n        _gl.linkProgram(program);\n\n        _gl.deleteShader(vertexShader);\n        _gl.deleteShader(fragmentShader);\n\n        this._program = program;\n\n        // Save code.\n        this.vertexCode = vertexShaderCode;\n        this.fragmentCode = fragmentShaderCode;\n\n        if (!_gl.getProgramParameter(program, _gl.LINK_STATUS)) {\n            return 'Could not link program\\n' + _gl.getProgramInfoLog(program);\n        }\n\n        // Cache uniform locations\n        for (var i = 0; i < shader.uniforms.length; i++) {\n            var uniformSymbol = shader.uniforms[i];\n            this._locations[uniformSymbol] = _gl.getUniformLocation(program, uniformSymbol);\n        }\n\n    }\n});\n\nexport default GLProgram;"]},"metadata":{},"sourceType":"module"}