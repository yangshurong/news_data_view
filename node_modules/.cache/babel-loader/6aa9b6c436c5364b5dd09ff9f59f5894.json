{"ast":null,"code":"import \"core-js/modules/es.array.map.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.typed-array.float32-array.js\";\nimport \"core-js/modules/es.typed-array.at.js\";\nimport \"core-js/modules/es.typed-array.copy-within.js\";\nimport \"core-js/modules/es.typed-array.every.js\";\nimport \"core-js/modules/es.typed-array.fill.js\";\nimport \"core-js/modules/es.typed-array.filter.js\";\nimport \"core-js/modules/es.typed-array.find.js\";\nimport \"core-js/modules/es.typed-array.find-index.js\";\nimport \"core-js/modules/es.typed-array.for-each.js\";\nimport \"core-js/modules/es.typed-array.includes.js\";\nimport \"core-js/modules/es.typed-array.index-of.js\";\nimport \"core-js/modules/es.typed-array.iterator.js\";\nimport \"core-js/modules/es.typed-array.join.js\";\nimport \"core-js/modules/es.typed-array.last-index-of.js\";\nimport \"core-js/modules/es.typed-array.map.js\";\nimport \"core-js/modules/es.typed-array.reduce.js\";\nimport \"core-js/modules/es.typed-array.reduce-right.js\";\nimport \"core-js/modules/es.typed-array.reverse.js\";\nimport \"core-js/modules/es.typed-array.set.js\";\nimport \"core-js/modules/es.typed-array.slice.js\";\nimport \"core-js/modules/es.typed-array.some.js\";\nimport \"core-js/modules/es.typed-array.sort.js\";\nimport \"core-js/modules/es.typed-array.subarray.js\";\nimport \"core-js/modules/es.typed-array.to-locale-string.js\";\nimport \"core-js/modules/es.typed-array.to-string.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport Shader from 'claygl/src/Shader';\nimport Texture2D from 'claygl/src/Texture2D';\nimport Texture from 'claygl/src/Texture';\nimport FrameBuffer from 'claygl/src/FrameBuffer';\nimport createCompositor from 'claygl/src/compositor/createCompositor';\nimport SSAOPass from './SSAOPass';\nimport SSRPass from './SSRPass';\nimport poissonKernel from './poissonKernel';\nimport graphicGL from '../util/graphicGL';\nimport NormalPass from './NormalPass';\nimport EdgePass from './EdgePass';\nimport effectJson from './composite.js';\nimport blurCode from 'claygl/src/shader/source/compositor/blur.glsl.js';\nimport lutCode from 'claygl/src/shader/source/compositor/lut.glsl.js';\nimport outputCode from 'claygl/src/shader/source/compositor/output.glsl.js';\nimport brightCode from 'claygl/src/shader/source/compositor/bright.glsl.js';\nimport downsampleCode from 'claygl/src/shader/source/compositor/downsample.glsl.js';\nimport upsampleCode from 'claygl/src/shader/source/compositor/upsample.glsl.js';\nimport hdrCode from 'claygl/src/shader/source/compositor/hdr.glsl.js';\nimport blendCode from 'claygl/src/shader/source/compositor/blend.glsl.js';\nimport fxaaCode from 'claygl/src/shader/source/compositor/fxaa.glsl.js';\nimport DOFCode from './DOF.glsl.js';\nimport edgeCode from './edge.glsl.js';\nShader['import'](blurCode);\nShader['import'](lutCode);\nShader['import'](outputCode);\nShader['import'](brightCode);\nShader['import'](downsampleCode);\nShader['import'](upsampleCode);\nShader['import'](hdrCode);\nShader['import'](blendCode);\nShader['import'](fxaaCode);\nShader['import'](DOFCode);\nShader['import'](edgeCode);\n\nfunction makeCommonOutputs(getWidth, getHeight) {\n  return {\n    color: {\n      parameters: {\n        width: getWidth,\n        height: getHeight\n      }\n    }\n  };\n}\n\nvar FINAL_NODES_CHAIN = ['composite', 'FXAA'];\n\nfunction EffectCompositor() {\n  this._width;\n  this._height;\n  this._dpr;\n  this._sourceTexture = new Texture2D({\n    type: Texture.HALF_FLOAT\n  });\n  this._depthTexture = new Texture2D({\n    format: Texture.DEPTH_COMPONENT,\n    type: Texture.UNSIGNED_INT\n  });\n  this._framebuffer = new FrameBuffer();\n\n  this._framebuffer.attach(this._sourceTexture);\n\n  this._framebuffer.attach(this._depthTexture, FrameBuffer.DEPTH_ATTACHMENT);\n\n  this._normalPass = new NormalPass();\n  this._compositor = createCompositor(effectJson);\n\n  var sourceNode = this._compositor.getNodeByName('source');\n\n  sourceNode.texture = this._sourceTexture;\n\n  var cocNode = this._compositor.getNodeByName('coc');\n\n  this._sourceNode = sourceNode;\n  this._cocNode = cocNode;\n  this._compositeNode = this._compositor.getNodeByName('composite');\n  this._fxaaNode = this._compositor.getNodeByName('FXAA');\n  this._dofBlurNodes = ['dof_far_blur', 'dof_near_blur', 'dof_coc_blur'].map(function (name) {\n    return this._compositor.getNodeByName(name);\n  }, this);\n  this._dofBlurKernel = 0;\n  this._dofBlurKernelSize = new Float32Array(0);\n  this._finalNodesChain = FINAL_NODES_CHAIN.map(function (name) {\n    return this._compositor.getNodeByName(name);\n  }, this);\n  var gBufferObj = {\n    normalTexture: this._normalPass.getNormalTexture(),\n    depthTexture: this._normalPass.getDepthTexture()\n  };\n  this._ssaoPass = new SSAOPass(gBufferObj);\n  this._ssrPass = new SSRPass(gBufferObj);\n  this._edgePass = new EdgePass(gBufferObj);\n}\n\nEffectCompositor.prototype.resize = function (width, height, dpr) {\n  dpr = dpr || 1;\n  var width = width * dpr;\n  var height = height * dpr;\n  var sourceTexture = this._sourceTexture;\n  var depthTexture = this._depthTexture;\n  sourceTexture.width = width;\n  sourceTexture.height = height;\n  depthTexture.width = width;\n  depthTexture.height = height;\n  var rendererMock = {\n    getWidth: function getWidth() {\n      return width;\n    },\n    getHeight: function getHeight() {\n      return height;\n    },\n    getDevicePixelRatio: function getDevicePixelRatio() {\n      return dpr;\n    }\n  };\n\n  function wrapCallback(obj, key) {\n    if (typeof obj[key] === 'function') {\n      var oldFunc = obj[key].__original || obj[key]; // Use viewport width/height instead of renderer width/height\n\n      obj[key] = function (renderer) {\n        return oldFunc.call(this, rendererMock);\n      };\n\n      obj[key].__original = oldFunc;\n    }\n  }\n\n  this._compositor.nodes.forEach(function (node) {\n    for (var outKey in node.outputs) {\n      var parameters = node.outputs[outKey].parameters;\n\n      if (parameters) {\n        wrapCallback(parameters, 'width');\n        wrapCallback(parameters, 'height');\n      }\n    }\n\n    for (var paramKey in node.parameters) {\n      wrapCallback(node.parameters, paramKey);\n    }\n  });\n\n  this._width = width;\n  this._height = height;\n  this._dpr = dpr;\n};\n\nEffectCompositor.prototype.getWidth = function () {\n  return this._width;\n};\n\nEffectCompositor.prototype.getHeight = function () {\n  return this._height;\n};\n\nEffectCompositor.prototype._ifRenderNormalPass = function () {\n  return this._enableSSAO || this._enableEdge || this._enableSSR;\n};\n\nEffectCompositor.prototype._getPrevNode = function (node) {\n  var idx = FINAL_NODES_CHAIN.indexOf(node.name) - 1;\n  var prevNode = this._finalNodesChain[idx];\n\n  while (prevNode && !this._compositor.getNodeByName(prevNode.name)) {\n    idx -= 1;\n    prevNode = this._finalNodesChain[idx];\n  }\n\n  return prevNode;\n};\n\nEffectCompositor.prototype._getNextNode = function (node) {\n  var idx = FINAL_NODES_CHAIN.indexOf(node.name) + 1;\n  var nextNode = this._finalNodesChain[idx];\n\n  while (nextNode && !this._compositor.getNodeByName(nextNode.name)) {\n    idx += 1;\n    nextNode = this._finalNodesChain[idx];\n  }\n\n  return nextNode;\n};\n\nEffectCompositor.prototype._addChainNode = function (node) {\n  var prevNode = this._getPrevNode(node);\n\n  var nextNode = this._getNextNode(node);\n\n  if (!prevNode) {\n    return;\n  }\n\n  node.inputs.texture = prevNode.name;\n\n  if (nextNode) {\n    node.outputs = makeCommonOutputs(this.getWidth.bind(this), this.getHeight.bind(this));\n    nextNode.inputs.texture = node.name;\n  } else {\n    node.outputs = null;\n  }\n\n  this._compositor.addNode(node);\n};\n\nEffectCompositor.prototype._removeChainNode = function (node) {\n  var prevNode = this._getPrevNode(node);\n\n  var nextNode = this._getNextNode(node);\n\n  if (!prevNode) {\n    return;\n  }\n\n  if (nextNode) {\n    prevNode.outputs = makeCommonOutputs(this.getWidth.bind(this), this.getHeight.bind(this));\n    nextNode.inputs.texture = prevNode.name;\n  } else {\n    prevNode.outputs = null;\n  }\n\n  this._compositor.removeNode(node);\n};\n/**\n * Update normal\n */\n\n\nEffectCompositor.prototype.updateNormal = function (renderer, scene, camera, frame) {\n  if (this._ifRenderNormalPass()) {\n    this._normalPass.update(renderer, scene, camera);\n  }\n};\n/**\n * Render SSAO after render the scene, before compositing\n */\n\n\nEffectCompositor.prototype.updateSSAO = function (renderer, scene, camera, frame) {\n  this._ssaoPass.update(renderer, camera, frame);\n};\n/**\n * Enable SSAO effect\n */\n\n\nEffectCompositor.prototype.enableSSAO = function () {\n  this._enableSSAO = true;\n};\n/**\n * Disable SSAO effect\n */\n\n\nEffectCompositor.prototype.disableSSAO = function () {\n  this._enableSSAO = false;\n};\n/**\n * Enable SSR effect\n */\n\n\nEffectCompositor.prototype.enableSSR = function () {\n  this._enableSSR = true; // this._normalPass.enableTargetTexture3 = true;\n};\n/**\n * Disable SSR effect\n */\n\n\nEffectCompositor.prototype.disableSSR = function () {\n  this._enableSSR = false; // this._normalPass.enableTargetTexture3 = false;\n};\n/**\n * Render SSAO after render the scene, before compositing\n */\n\n\nEffectCompositor.prototype.getSSAOTexture = function () {\n  return this._ssaoPass.getTargetTexture();\n};\n/**\n * @return {clay.FrameBuffer}\n */\n\n\nEffectCompositor.prototype.getSourceFrameBuffer = function () {\n  return this._framebuffer;\n};\n/**\n * @return {clay.Texture2D}\n */\n\n\nEffectCompositor.prototype.getSourceTexture = function () {\n  return this._sourceTexture;\n};\n/**\n * Disable fxaa effect\n */\n\n\nEffectCompositor.prototype.disableFXAA = function () {\n  this._removeChainNode(this._fxaaNode);\n};\n/**\n * Enable fxaa effect\n */\n\n\nEffectCompositor.prototype.enableFXAA = function () {\n  this._addChainNode(this._fxaaNode);\n};\n/**\n * Enable bloom effect\n */\n\n\nEffectCompositor.prototype.enableBloom = function () {\n  this._compositeNode.inputs.bloom = 'bloom_composite';\n\n  this._compositor.dirty();\n};\n/**\n * Disable bloom effect\n */\n\n\nEffectCompositor.prototype.disableBloom = function () {\n  this._compositeNode.inputs.bloom = null;\n\n  this._compositor.dirty();\n};\n/**\n * Enable depth of field effect\n */\n\n\nEffectCompositor.prototype.enableDOF = function () {\n  this._compositeNode.inputs.texture = 'dof_composite';\n\n  this._compositor.dirty();\n};\n/**\n * Disable depth of field effect\n */\n\n\nEffectCompositor.prototype.disableDOF = function () {\n  this._compositeNode.inputs.texture = 'source';\n\n  this._compositor.dirty();\n};\n/**\n * Enable color correction\n */\n\n\nEffectCompositor.prototype.enableColorCorrection = function () {\n  this._compositeNode.define('COLOR_CORRECTION');\n\n  this._enableColorCorrection = true;\n};\n/**\n * Disable color correction\n */\n\n\nEffectCompositor.prototype.disableColorCorrection = function () {\n  this._compositeNode.undefine('COLOR_CORRECTION');\n\n  this._enableColorCorrection = false;\n};\n/**\n * Enable edge detection\n */\n\n\nEffectCompositor.prototype.enableEdge = function () {\n  this._enableEdge = true;\n};\n/**\n * Disable edge detection\n */\n\n\nEffectCompositor.prototype.disableEdge = function () {\n  this._enableEdge = false;\n};\n/**\n * Set bloom intensity\n * @param {number} value\n */\n\n\nEffectCompositor.prototype.setBloomIntensity = function (value) {\n  this._compositeNode.setParameter('bloomIntensity', value);\n};\n\nEffectCompositor.prototype.setSSAOParameter = function (name, value) {\n  switch (name) {\n    case 'quality':\n      // PENDING\n      var kernelSize = {\n        low: 6,\n        medium: 12,\n        high: 32,\n        ultra: 62\n      }[value] || 12;\n\n      this._ssaoPass.setParameter('kernelSize', kernelSize);\n\n      break;\n\n    case 'radius':\n      this._ssaoPass.setParameter(name, value);\n\n      this._ssaoPass.setParameter('bias', value / 200);\n\n      break;\n\n    case 'intensity':\n      this._ssaoPass.setParameter(name, value);\n\n      break;\n\n    default:\n      if (process.env.NODE_ENV !== 'production') {\n        console.warn('Unkown SSAO parameter ' + name);\n      }\n\n  }\n};\n\nEffectCompositor.prototype.setDOFParameter = function (name, value) {\n  switch (name) {\n    case 'focalDistance':\n    case 'focalRange':\n    case 'fstop':\n      this._cocNode.setParameter(name, value);\n\n      break;\n\n    case 'blurRadius':\n      for (var i = 0; i < this._dofBlurNodes.length; i++) {\n        this._dofBlurNodes[i].setParameter('blurRadius', value);\n      }\n\n      break;\n\n    case 'quality':\n      var kernelSize = {\n        low: 4,\n        medium: 8,\n        high: 16,\n        ultra: 32\n      }[value] || 8;\n      this._dofBlurKernelSize = kernelSize;\n\n      for (var i = 0; i < this._dofBlurNodes.length; i++) {\n        this._dofBlurNodes[i].pass.material.define('POISSON_KERNEL_SIZE', kernelSize);\n      }\n\n      this._dofBlurKernel = new Float32Array(kernelSize * 2);\n      break;\n\n    default:\n      if (process.env.NODE_ENV !== 'production') {\n        console.warn('Unkown DOF parameter ' + name);\n      }\n\n  }\n};\n\nEffectCompositor.prototype.setSSRParameter = function (name, value) {\n  if (value == null) {\n    return;\n  }\n\n  switch (name) {\n    case 'quality':\n      // PENDING\n      var maxIteration = {\n        low: 10,\n        medium: 15,\n        high: 30,\n        ultra: 80\n      }[value] || 20;\n      var pixelStride = {\n        low: 32,\n        medium: 16,\n        high: 8,\n        ultra: 4\n      }[value] || 16;\n\n      this._ssrPass.setParameter('maxIteration', maxIteration);\n\n      this._ssrPass.setParameter('pixelStride', pixelStride);\n\n      break;\n\n    case 'maxRoughness':\n      this._ssrPass.setParameter('minGlossiness', Math.max(Math.min(1.0 - value, 1.0), 0.0));\n\n      break;\n\n    case 'physical':\n      this.setPhysicallyCorrectSSR(value);\n      break;\n\n    default:\n      console.warn('Unkown SSR parameter ' + name);\n  }\n};\n\nEffectCompositor.prototype.setPhysicallyCorrectSSR = function (physical) {\n  this._ssrPass.setPhysicallyCorrect(physical);\n};\n/**\n * Set color of edge\n */\n\n\nEffectCompositor.prototype.setEdgeColor = function (value) {\n  var color = graphicGL.parseColor(value);\n\n  this._edgePass.setParameter('edgeColor', color);\n};\n\nEffectCompositor.prototype.setExposure = function (value) {\n  this._compositeNode.setParameter('exposure', Math.pow(2, value));\n};\n\nEffectCompositor.prototype.setColorLookupTexture = function (image, api) {\n  this._compositeNode.pass.material.setTextureImage('lut', this._enableColorCorrection ? image : 'none', api, {\n    minFilter: graphicGL.Texture.NEAREST,\n    magFilter: graphicGL.Texture.NEAREST,\n    flipY: false\n  });\n};\n\nEffectCompositor.prototype.setColorCorrection = function (type, value) {\n  this._compositeNode.setParameter(type, value);\n};\n\nEffectCompositor.prototype.isSSREnabled = function () {\n  return this._enableSSR;\n};\n\nEffectCompositor.prototype.composite = function (renderer, scene, camera, framebuffer, frame) {\n  var sourceTexture = this._sourceTexture;\n  var targetTexture = sourceTexture;\n\n  if (this._enableEdge) {\n    this._edgePass.update(renderer, camera, sourceTexture, frame);\n\n    sourceTexture = targetTexture = this._edgePass.getTargetTexture();\n  }\n\n  if (this._enableSSR) {\n    this._ssrPass.update(renderer, camera, sourceTexture, frame);\n\n    targetTexture = this._ssrPass.getTargetTexture();\n\n    this._ssrPass.setSSAOTexture(this._enableSSAO ? this._ssaoPass.getTargetTexture() : null); // var lights = scene.getLights();\n    // for (var i = 0; i < lights.length; i++) {\n    //     if (lights[i].cubemap) {\n    //         this._ssrPass.setAmbientCubemap(lights[i].cubemap, lights[i].intensity);\n    //     }\n    // }\n\n  }\n\n  this._sourceNode.texture = targetTexture;\n\n  this._cocNode.setParameter('depth', this._depthTexture);\n\n  var blurKernel = this._dofBlurKernel;\n  var blurKernelSize = this._dofBlurKernelSize;\n  var frameAll = Math.floor(poissonKernel.length / 2 / blurKernelSize);\n  var kernelOffset = frame % frameAll;\n\n  for (var i = 0; i < blurKernelSize * 2; i++) {\n    blurKernel[i] = poissonKernel[i + kernelOffset * blurKernelSize * 2];\n  }\n\n  for (var i = 0; i < this._dofBlurNodes.length; i++) {\n    this._dofBlurNodes[i].setParameter('percent', frame / 30.0);\n\n    this._dofBlurNodes[i].setParameter('poissonKernel', blurKernel);\n  }\n\n  this._cocNode.setParameter('zNear', camera.near);\n\n  this._cocNode.setParameter('zFar', camera.far);\n\n  this._compositor.render(renderer, framebuffer);\n};\n\nEffectCompositor.prototype.dispose = function (renderer) {\n  this._sourceTexture.dispose(renderer);\n\n  this._depthTexture.dispose(renderer);\n\n  this._framebuffer.dispose(renderer);\n\n  this._compositor.dispose(renderer);\n\n  this._normalPass.dispose(renderer);\n\n  this._ssaoPass.dispose(renderer);\n};\n\nexport default EffectCompositor;","map":{"version":3,"sources":["C:/Users/Administrator/Desktop/data_view/my_project/vue2_app/myapp/node_modules/_echarts-gl@2.0.9@echarts-gl/lib/effect/EffectCompositor.js"],"names":["Shader","Texture2D","Texture","FrameBuffer","createCompositor","SSAOPass","SSRPass","poissonKernel","graphicGL","NormalPass","EdgePass","effectJson","blurCode","lutCode","outputCode","brightCode","downsampleCode","upsampleCode","hdrCode","blendCode","fxaaCode","DOFCode","edgeCode","makeCommonOutputs","getWidth","getHeight","color","parameters","width","height","FINAL_NODES_CHAIN","EffectCompositor","_width","_height","_dpr","_sourceTexture","type","HALF_FLOAT","_depthTexture","format","DEPTH_COMPONENT","UNSIGNED_INT","_framebuffer","attach","DEPTH_ATTACHMENT","_normalPass","_compositor","sourceNode","getNodeByName","texture","cocNode","_sourceNode","_cocNode","_compositeNode","_fxaaNode","_dofBlurNodes","map","name","_dofBlurKernel","_dofBlurKernelSize","Float32Array","_finalNodesChain","gBufferObj","normalTexture","getNormalTexture","depthTexture","getDepthTexture","_ssaoPass","_ssrPass","_edgePass","prototype","resize","dpr","sourceTexture","rendererMock","getDevicePixelRatio","wrapCallback","obj","key","oldFunc","__original","renderer","call","nodes","forEach","node","outKey","outputs","paramKey","_ifRenderNormalPass","_enableSSAO","_enableEdge","_enableSSR","_getPrevNode","idx","indexOf","prevNode","_getNextNode","nextNode","_addChainNode","inputs","bind","addNode","_removeChainNode","removeNode","updateNormal","scene","camera","frame","update","updateSSAO","enableSSAO","disableSSAO","enableSSR","disableSSR","getSSAOTexture","getTargetTexture","getSourceFrameBuffer","getSourceTexture","disableFXAA","enableFXAA","enableBloom","bloom","dirty","disableBloom","enableDOF","disableDOF","enableColorCorrection","define","_enableColorCorrection","disableColorCorrection","undefine","enableEdge","disableEdge","setBloomIntensity","value","setParameter","setSSAOParameter","kernelSize","low","medium","high","ultra","process","env","NODE_ENV","console","warn","setDOFParameter","i","length","pass","material","setSSRParameter","maxIteration","pixelStride","Math","max","min","setPhysicallyCorrectSSR","physical","setPhysicallyCorrect","setEdgeColor","parseColor","setExposure","pow","setColorLookupTexture","image","api","setTextureImage","minFilter","NEAREST","magFilter","flipY","setColorCorrection","isSSREnabled","composite","framebuffer","targetTexture","setSSAOTexture","blurKernel","blurKernelSize","frameAll","floor","kernelOffset","near","far","render","dispose"],"mappings":"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","sourcesContent":["import Shader from 'claygl/src/Shader';\nimport Texture2D from 'claygl/src/Texture2D';\nimport Texture from 'claygl/src/Texture';\nimport FrameBuffer from 'claygl/src/FrameBuffer';\nimport createCompositor from 'claygl/src/compositor/createCompositor';\nimport SSAOPass from './SSAOPass';\nimport SSRPass from './SSRPass';\nimport poissonKernel from './poissonKernel';\nimport graphicGL from '../util/graphicGL';\nimport NormalPass from './NormalPass';\nimport EdgePass from './EdgePass';\nimport effectJson from './composite.js';\nimport blurCode from 'claygl/src/shader/source/compositor/blur.glsl.js';\nimport lutCode from 'claygl/src/shader/source/compositor/lut.glsl.js';\nimport outputCode from 'claygl/src/shader/source/compositor/output.glsl.js';\nimport brightCode from 'claygl/src/shader/source/compositor/bright.glsl.js';\nimport downsampleCode from 'claygl/src/shader/source/compositor/downsample.glsl.js';\nimport upsampleCode from 'claygl/src/shader/source/compositor/upsample.glsl.js';\nimport hdrCode from 'claygl/src/shader/source/compositor/hdr.glsl.js';\nimport blendCode from 'claygl/src/shader/source/compositor/blend.glsl.js';\nimport fxaaCode from 'claygl/src/shader/source/compositor/fxaa.glsl.js';\nimport DOFCode from './DOF.glsl.js';\nimport edgeCode from './edge.glsl.js';\nShader['import'](blurCode);\nShader['import'](lutCode);\nShader['import'](outputCode);\nShader['import'](brightCode);\nShader['import'](downsampleCode);\nShader['import'](upsampleCode);\nShader['import'](hdrCode);\nShader['import'](blendCode);\nShader['import'](fxaaCode);\nShader['import'](DOFCode);\nShader['import'](edgeCode);\n\nfunction makeCommonOutputs(getWidth, getHeight) {\n  return {\n    color: {\n      parameters: {\n        width: getWidth,\n        height: getHeight\n      }\n    }\n  };\n}\n\nvar FINAL_NODES_CHAIN = ['composite', 'FXAA'];\n\nfunction EffectCompositor() {\n  this._width;\n  this._height;\n  this._dpr;\n  this._sourceTexture = new Texture2D({\n    type: Texture.HALF_FLOAT\n  });\n  this._depthTexture = new Texture2D({\n    format: Texture.DEPTH_COMPONENT,\n    type: Texture.UNSIGNED_INT\n  });\n  this._framebuffer = new FrameBuffer();\n\n  this._framebuffer.attach(this._sourceTexture);\n\n  this._framebuffer.attach(this._depthTexture, FrameBuffer.DEPTH_ATTACHMENT);\n\n  this._normalPass = new NormalPass();\n  this._compositor = createCompositor(effectJson);\n\n  var sourceNode = this._compositor.getNodeByName('source');\n\n  sourceNode.texture = this._sourceTexture;\n\n  var cocNode = this._compositor.getNodeByName('coc');\n\n  this._sourceNode = sourceNode;\n  this._cocNode = cocNode;\n  this._compositeNode = this._compositor.getNodeByName('composite');\n  this._fxaaNode = this._compositor.getNodeByName('FXAA');\n  this._dofBlurNodes = ['dof_far_blur', 'dof_near_blur', 'dof_coc_blur'].map(function (name) {\n    return this._compositor.getNodeByName(name);\n  }, this);\n  this._dofBlurKernel = 0;\n  this._dofBlurKernelSize = new Float32Array(0);\n  this._finalNodesChain = FINAL_NODES_CHAIN.map(function (name) {\n    return this._compositor.getNodeByName(name);\n  }, this);\n  var gBufferObj = {\n    normalTexture: this._normalPass.getNormalTexture(),\n    depthTexture: this._normalPass.getDepthTexture()\n  };\n  this._ssaoPass = new SSAOPass(gBufferObj);\n  this._ssrPass = new SSRPass(gBufferObj);\n  this._edgePass = new EdgePass(gBufferObj);\n}\n\nEffectCompositor.prototype.resize = function (width, height, dpr) {\n  dpr = dpr || 1;\n  var width = width * dpr;\n  var height = height * dpr;\n  var sourceTexture = this._sourceTexture;\n  var depthTexture = this._depthTexture;\n  sourceTexture.width = width;\n  sourceTexture.height = height;\n  depthTexture.width = width;\n  depthTexture.height = height;\n  var rendererMock = {\n    getWidth: function () {\n      return width;\n    },\n    getHeight: function () {\n      return height;\n    },\n    getDevicePixelRatio: function () {\n      return dpr;\n    }\n  };\n\n  function wrapCallback(obj, key) {\n    if (typeof obj[key] === 'function') {\n      var oldFunc = obj[key].__original || obj[key]; // Use viewport width/height instead of renderer width/height\n\n      obj[key] = function (renderer) {\n        return oldFunc.call(this, rendererMock);\n      };\n\n      obj[key].__original = oldFunc;\n    }\n  }\n\n  this._compositor.nodes.forEach(function (node) {\n    for (var outKey in node.outputs) {\n      var parameters = node.outputs[outKey].parameters;\n\n      if (parameters) {\n        wrapCallback(parameters, 'width');\n        wrapCallback(parameters, 'height');\n      }\n    }\n\n    for (var paramKey in node.parameters) {\n      wrapCallback(node.parameters, paramKey);\n    }\n  });\n\n  this._width = width;\n  this._height = height;\n  this._dpr = dpr;\n};\n\nEffectCompositor.prototype.getWidth = function () {\n  return this._width;\n};\n\nEffectCompositor.prototype.getHeight = function () {\n  return this._height;\n};\n\nEffectCompositor.prototype._ifRenderNormalPass = function () {\n  return this._enableSSAO || this._enableEdge || this._enableSSR;\n};\n\nEffectCompositor.prototype._getPrevNode = function (node) {\n  var idx = FINAL_NODES_CHAIN.indexOf(node.name) - 1;\n  var prevNode = this._finalNodesChain[idx];\n\n  while (prevNode && !this._compositor.getNodeByName(prevNode.name)) {\n    idx -= 1;\n    prevNode = this._finalNodesChain[idx];\n  }\n\n  return prevNode;\n};\n\nEffectCompositor.prototype._getNextNode = function (node) {\n  var idx = FINAL_NODES_CHAIN.indexOf(node.name) + 1;\n  var nextNode = this._finalNodesChain[idx];\n\n  while (nextNode && !this._compositor.getNodeByName(nextNode.name)) {\n    idx += 1;\n    nextNode = this._finalNodesChain[idx];\n  }\n\n  return nextNode;\n};\n\nEffectCompositor.prototype._addChainNode = function (node) {\n  var prevNode = this._getPrevNode(node);\n\n  var nextNode = this._getNextNode(node);\n\n  if (!prevNode) {\n    return;\n  }\n\n  node.inputs.texture = prevNode.name;\n\n  if (nextNode) {\n    node.outputs = makeCommonOutputs(this.getWidth.bind(this), this.getHeight.bind(this));\n    nextNode.inputs.texture = node.name;\n  } else {\n    node.outputs = null;\n  }\n\n  this._compositor.addNode(node);\n};\n\nEffectCompositor.prototype._removeChainNode = function (node) {\n  var prevNode = this._getPrevNode(node);\n\n  var nextNode = this._getNextNode(node);\n\n  if (!prevNode) {\n    return;\n  }\n\n  if (nextNode) {\n    prevNode.outputs = makeCommonOutputs(this.getWidth.bind(this), this.getHeight.bind(this));\n    nextNode.inputs.texture = prevNode.name;\n  } else {\n    prevNode.outputs = null;\n  }\n\n  this._compositor.removeNode(node);\n};\n/**\n * Update normal\n */\n\n\nEffectCompositor.prototype.updateNormal = function (renderer, scene, camera, frame) {\n  if (this._ifRenderNormalPass()) {\n    this._normalPass.update(renderer, scene, camera);\n  }\n};\n/**\n * Render SSAO after render the scene, before compositing\n */\n\n\nEffectCompositor.prototype.updateSSAO = function (renderer, scene, camera, frame) {\n  this._ssaoPass.update(renderer, camera, frame);\n};\n/**\n * Enable SSAO effect\n */\n\n\nEffectCompositor.prototype.enableSSAO = function () {\n  this._enableSSAO = true;\n};\n/**\n * Disable SSAO effect\n */\n\n\nEffectCompositor.prototype.disableSSAO = function () {\n  this._enableSSAO = false;\n};\n/**\n * Enable SSR effect\n */\n\n\nEffectCompositor.prototype.enableSSR = function () {\n  this._enableSSR = true; // this._normalPass.enableTargetTexture3 = true;\n};\n/**\n * Disable SSR effect\n */\n\n\nEffectCompositor.prototype.disableSSR = function () {\n  this._enableSSR = false; // this._normalPass.enableTargetTexture3 = false;\n};\n/**\n * Render SSAO after render the scene, before compositing\n */\n\n\nEffectCompositor.prototype.getSSAOTexture = function () {\n  return this._ssaoPass.getTargetTexture();\n};\n/**\n * @return {clay.FrameBuffer}\n */\n\n\nEffectCompositor.prototype.getSourceFrameBuffer = function () {\n  return this._framebuffer;\n};\n/**\n * @return {clay.Texture2D}\n */\n\n\nEffectCompositor.prototype.getSourceTexture = function () {\n  return this._sourceTexture;\n};\n/**\n * Disable fxaa effect\n */\n\n\nEffectCompositor.prototype.disableFXAA = function () {\n  this._removeChainNode(this._fxaaNode);\n};\n/**\n * Enable fxaa effect\n */\n\n\nEffectCompositor.prototype.enableFXAA = function () {\n  this._addChainNode(this._fxaaNode);\n};\n/**\n * Enable bloom effect\n */\n\n\nEffectCompositor.prototype.enableBloom = function () {\n  this._compositeNode.inputs.bloom = 'bloom_composite';\n\n  this._compositor.dirty();\n};\n/**\n * Disable bloom effect\n */\n\n\nEffectCompositor.prototype.disableBloom = function () {\n  this._compositeNode.inputs.bloom = null;\n\n  this._compositor.dirty();\n};\n/**\n * Enable depth of field effect\n */\n\n\nEffectCompositor.prototype.enableDOF = function () {\n  this._compositeNode.inputs.texture = 'dof_composite';\n\n  this._compositor.dirty();\n};\n/**\n * Disable depth of field effect\n */\n\n\nEffectCompositor.prototype.disableDOF = function () {\n  this._compositeNode.inputs.texture = 'source';\n\n  this._compositor.dirty();\n};\n/**\n * Enable color correction\n */\n\n\nEffectCompositor.prototype.enableColorCorrection = function () {\n  this._compositeNode.define('COLOR_CORRECTION');\n\n  this._enableColorCorrection = true;\n};\n/**\n * Disable color correction\n */\n\n\nEffectCompositor.prototype.disableColorCorrection = function () {\n  this._compositeNode.undefine('COLOR_CORRECTION');\n\n  this._enableColorCorrection = false;\n};\n/**\n * Enable edge detection\n */\n\n\nEffectCompositor.prototype.enableEdge = function () {\n  this._enableEdge = true;\n};\n/**\n * Disable edge detection\n */\n\n\nEffectCompositor.prototype.disableEdge = function () {\n  this._enableEdge = false;\n};\n/**\n * Set bloom intensity\n * @param {number} value\n */\n\n\nEffectCompositor.prototype.setBloomIntensity = function (value) {\n  this._compositeNode.setParameter('bloomIntensity', value);\n};\n\nEffectCompositor.prototype.setSSAOParameter = function (name, value) {\n  switch (name) {\n    case 'quality':\n      // PENDING\n      var kernelSize = {\n        low: 6,\n        medium: 12,\n        high: 32,\n        ultra: 62\n      }[value] || 12;\n\n      this._ssaoPass.setParameter('kernelSize', kernelSize);\n\n      break;\n\n    case 'radius':\n      this._ssaoPass.setParameter(name, value);\n\n      this._ssaoPass.setParameter('bias', value / 200);\n\n      break;\n\n    case 'intensity':\n      this._ssaoPass.setParameter(name, value);\n\n      break;\n\n    default:\n      if (process.env.NODE_ENV !== 'production') {\n        console.warn('Unkown SSAO parameter ' + name);\n      }\n\n  }\n};\n\nEffectCompositor.prototype.setDOFParameter = function (name, value) {\n  switch (name) {\n    case 'focalDistance':\n    case 'focalRange':\n    case 'fstop':\n      this._cocNode.setParameter(name, value);\n\n      break;\n\n    case 'blurRadius':\n      for (var i = 0; i < this._dofBlurNodes.length; i++) {\n        this._dofBlurNodes[i].setParameter('blurRadius', value);\n      }\n\n      break;\n\n    case 'quality':\n      var kernelSize = {\n        low: 4,\n        medium: 8,\n        high: 16,\n        ultra: 32\n      }[value] || 8;\n      this._dofBlurKernelSize = kernelSize;\n\n      for (var i = 0; i < this._dofBlurNodes.length; i++) {\n        this._dofBlurNodes[i].pass.material.define('POISSON_KERNEL_SIZE', kernelSize);\n      }\n\n      this._dofBlurKernel = new Float32Array(kernelSize * 2);\n      break;\n\n    default:\n      if (process.env.NODE_ENV !== 'production') {\n        console.warn('Unkown DOF parameter ' + name);\n      }\n\n  }\n};\n\nEffectCompositor.prototype.setSSRParameter = function (name, value) {\n  if (value == null) {\n    return;\n  }\n\n  switch (name) {\n    case 'quality':\n      // PENDING\n      var maxIteration = {\n        low: 10,\n        medium: 15,\n        high: 30,\n        ultra: 80\n      }[value] || 20;\n      var pixelStride = {\n        low: 32,\n        medium: 16,\n        high: 8,\n        ultra: 4\n      }[value] || 16;\n\n      this._ssrPass.setParameter('maxIteration', maxIteration);\n\n      this._ssrPass.setParameter('pixelStride', pixelStride);\n\n      break;\n\n    case 'maxRoughness':\n      this._ssrPass.setParameter('minGlossiness', Math.max(Math.min(1.0 - value, 1.0), 0.0));\n\n      break;\n\n    case 'physical':\n      this.setPhysicallyCorrectSSR(value);\n      break;\n\n    default:\n      console.warn('Unkown SSR parameter ' + name);\n  }\n};\n\nEffectCompositor.prototype.setPhysicallyCorrectSSR = function (physical) {\n  this._ssrPass.setPhysicallyCorrect(physical);\n};\n/**\n * Set color of edge\n */\n\n\nEffectCompositor.prototype.setEdgeColor = function (value) {\n  var color = graphicGL.parseColor(value);\n\n  this._edgePass.setParameter('edgeColor', color);\n};\n\nEffectCompositor.prototype.setExposure = function (value) {\n  this._compositeNode.setParameter('exposure', Math.pow(2, value));\n};\n\nEffectCompositor.prototype.setColorLookupTexture = function (image, api) {\n  this._compositeNode.pass.material.setTextureImage('lut', this._enableColorCorrection ? image : 'none', api, {\n    minFilter: graphicGL.Texture.NEAREST,\n    magFilter: graphicGL.Texture.NEAREST,\n    flipY: false\n  });\n};\n\nEffectCompositor.prototype.setColorCorrection = function (type, value) {\n  this._compositeNode.setParameter(type, value);\n};\n\nEffectCompositor.prototype.isSSREnabled = function () {\n  return this._enableSSR;\n};\n\nEffectCompositor.prototype.composite = function (renderer, scene, camera, framebuffer, frame) {\n  var sourceTexture = this._sourceTexture;\n  var targetTexture = sourceTexture;\n\n  if (this._enableEdge) {\n    this._edgePass.update(renderer, camera, sourceTexture, frame);\n\n    sourceTexture = targetTexture = this._edgePass.getTargetTexture();\n  }\n\n  if (this._enableSSR) {\n    this._ssrPass.update(renderer, camera, sourceTexture, frame);\n\n    targetTexture = this._ssrPass.getTargetTexture();\n\n    this._ssrPass.setSSAOTexture(this._enableSSAO ? this._ssaoPass.getTargetTexture() : null); // var lights = scene.getLights();\n    // for (var i = 0; i < lights.length; i++) {\n    //     if (lights[i].cubemap) {\n    //         this._ssrPass.setAmbientCubemap(lights[i].cubemap, lights[i].intensity);\n    //     }\n    // }\n\n  }\n\n  this._sourceNode.texture = targetTexture;\n\n  this._cocNode.setParameter('depth', this._depthTexture);\n\n  var blurKernel = this._dofBlurKernel;\n  var blurKernelSize = this._dofBlurKernelSize;\n  var frameAll = Math.floor(poissonKernel.length / 2 / blurKernelSize);\n  var kernelOffset = frame % frameAll;\n\n  for (var i = 0; i < blurKernelSize * 2; i++) {\n    blurKernel[i] = poissonKernel[i + kernelOffset * blurKernelSize * 2];\n  }\n\n  for (var i = 0; i < this._dofBlurNodes.length; i++) {\n    this._dofBlurNodes[i].setParameter('percent', frame / 30.0);\n\n    this._dofBlurNodes[i].setParameter('poissonKernel', blurKernel);\n  }\n\n  this._cocNode.setParameter('zNear', camera.near);\n\n  this._cocNode.setParameter('zFar', camera.far);\n\n  this._compositor.render(renderer, framebuffer);\n};\n\nEffectCompositor.prototype.dispose = function (renderer) {\n  this._sourceTexture.dispose(renderer);\n\n  this._depthTexture.dispose(renderer);\n\n  this._framebuffer.dispose(renderer);\n\n  this._compositor.dispose(renderer);\n\n  this._normalPass.dispose(renderer);\n\n  this._ssaoPass.dispose(renderer);\n};\n\nexport default EffectCompositor;"]},"metadata":{},"sourceType":"module"}